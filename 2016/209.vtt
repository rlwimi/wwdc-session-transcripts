WEBVTT

00:00:07.516 --> 00:00:19.500 A:middle
[ Music ]

00:00:24.516 --> 00:00:27.866 A:middle
[ Applause ]

00:00:28.366 --> 00:00:29.856 A:middle
&gt;&gt; Good morning, and welcome

00:00:29.856 --> 00:00:31.446 A:middle
to Getting the Most
Out of HealthKit.

00:00:31.996 --> 00:00:34.716 A:middle
I'm Matt, I'm a software
engineer on the HealthKit team,

00:00:34.826 --> 00:00:37.366 A:middle
and I'll be joined on stage
shortly by my colleague Jeff.

00:00:38.276 --> 00:00:40.726 A:middle
In this session, we'll be
going over some great new

00:00:40.726 --> 00:00:42.846 A:middle
and recent additions
to the HealthKit APIs

00:00:42.846 --> 00:00:44.566 A:middle
in iOS 10 and watchOS 3.

00:00:45.496 --> 00:00:48.866 A:middle
Just as importantly, we'll be
covering some key features,

00:00:48.866 --> 00:00:51.826 A:middle
core concepts, and important
workflows to make sure

00:00:51.826 --> 00:00:54.696 A:middle
that you're really able to
get the most out of HealthKit.

00:00:56.036 --> 00:00:58.026 A:middle
We expect you have some
familiarity with HealthKit

00:00:58.026 --> 00:01:00.176 A:middle
if you're here watching this
session, but if you don't,

00:01:00.176 --> 00:01:02.386 A:middle
we'll list some past sessions
at the end of this talk

00:01:02.386 --> 00:01:04.446 A:middle
that you can refer to
later to get up to speed.

00:01:05.216 --> 00:01:09.876 A:middle
But for now, let's get started.

00:01:09.996 --> 00:01:12.126 A:middle
As all of you here
know, Apple's health

00:01:12.126 --> 00:01:15.496 A:middle
and fitness ecosystem has become
a huge hit with our users.

00:01:16.176 --> 00:01:18.296 A:middle
People are getting more
fit and more healthy

00:01:18.296 --> 00:01:21.576 A:middle
because of the integration of
HealthKit and now ResearchKit

00:01:21.576 --> 00:01:24.096 A:middle
and CareKit with
your apps and devices

00:01:24.096 --> 00:01:25.386 A:middle
for iPhone and Apple Watch.

00:01:26.436 --> 00:01:28.346 A:middle
We want to make sure
that you're able

00:01:28.346 --> 00:01:29.976 A:middle
to keep creating
these great health

00:01:29.976 --> 00:01:31.526 A:middle
and fitness user experiences

00:01:31.526 --> 00:01:33.786 A:middle
that our users have come
to expect and enjoy.

00:01:35.316 --> 00:01:38.176 A:middle
So today we're going to be
covering all the things you need

00:01:38.176 --> 00:01:40.546 A:middle
to do to get these
great experiences right.

00:01:41.936 --> 00:01:43.856 A:middle
First, we'll cover
authorization,

00:01:43.856 --> 00:01:46.126 A:middle
which underpins everything
else you do with HealthKit.

00:01:47.076 --> 00:01:51.586 A:middle
Next, we'll cover the Activity
Rings API introduced in iOS 9.3

00:01:52.016 --> 00:01:54.446 A:middle
and Health Records
introduced this year in iOS 10,

00:01:54.976 --> 00:01:57.886 A:middle
both of which happen to have
important implications related

00:01:57.886 --> 00:01:58.766 A:middle
to authorization.

00:02:00.696 --> 00:02:02.836 A:middle
Finally, we'll spend the
rest of the session going

00:02:02.836 --> 00:02:05.626 A:middle
over a wide range of best
practices for handling data

00:02:05.836 --> 00:02:07.186 A:middle
when you're interacting
with HealthKit.

00:02:07.716 --> 00:02:11.776 A:middle
So let's dive in.

00:02:12.286 --> 00:02:13.946 A:middle
First up is authorization.

00:02:14.376 --> 00:02:17.416 A:middle
If you've been using HealthKit
for a while, some or even most

00:02:17.416 --> 00:02:18.856 A:middle
of this section might
feel like review,

00:02:19.366 --> 00:02:21.336 A:middle
but we really recommend
you pay important attention

00:02:21.336 --> 00:02:22.996 A:middle
to the details because
they'll be important

00:02:22.996 --> 00:02:24.706 A:middle
for the stuff we cover
later in this session.

00:02:25.286 --> 00:02:27.126 A:middle
We'll sprinkle in some
best practices as well,

00:02:27.126 --> 00:02:30.006 A:middle
so keep your ears peeled.

00:02:31.196 --> 00:02:34.636 A:middle
iOS gives users full control
over their health data

00:02:34.636 --> 00:02:37.196 A:middle
and which apps can access
which parts of that data.

00:02:38.396 --> 00:02:39.816 A:middle
Before interacting
with HealthKit,

00:02:40.226 --> 00:02:41.766 A:middle
your app should request access

00:02:41.766 --> 00:02:43.876 A:middle
to the appropriate types
via HK Health Store,

00:02:44.106 --> 00:02:45.276 A:middle
and then the Health Store

00:02:45.276 --> 00:02:47.866 A:middle
in turn will present the
appropriate authorization UI

00:02:47.866 --> 00:02:49.276 A:middle
to the user if necessary.

00:02:51.106 --> 00:02:53.786 A:middle
Be aware that the user can
change permissions for your app

00:02:53.786 --> 00:02:55.126 A:middle
at any time, so you should keep

00:02:55.126 --> 00:02:56.546 A:middle
that in mind while you're
developing your app.

00:02:57.026 --> 00:03:00.256 A:middle
And just as importantly,
read authorization

00:03:00.396 --> 00:03:02.666 A:middle
and write authorization
are completely independent.

00:03:03.526 --> 00:03:05.866 A:middle
That last bit can actually be
a little tricky, so let's look

00:03:05.866 --> 00:03:10.006 A:middle
at it in a little more detail.

00:03:11.266 --> 00:03:13.356 A:middle
Here's how read and write
authorizations work.

00:03:14.246 --> 00:03:16.926 A:middle
If the user grants you both
read and write permissions

00:03:16.926 --> 00:03:20.286 A:middle
to a given HealthKit type, then
your app can query and save data

00:03:20.286 --> 00:03:22.126 A:middle
for that HealthKit type
just like you'd expect.

00:03:22.816 --> 00:03:26.226 A:middle
If the user grants you only read
permissions for a given type,

00:03:26.226 --> 00:03:28.506 A:middle
then your app can read but
not write HealthKit data

00:03:28.506 --> 00:03:29.046 A:middle
for that type.

00:03:29.296 --> 00:03:30.096 A:middle
So far, so good.

00:03:30.096 --> 00:03:33.786 A:middle
Now, if the user grants
you write permissions

00:03:33.786 --> 00:03:36.896 A:middle
for a given type, then your
app can write data to HealthKit

00:03:36.896 --> 00:03:38.566 A:middle
for that type but
not read it back

00:03:38.566 --> 00:03:39.626 A:middle
from HealthKit for that type.

00:03:40.276 --> 00:03:42.966 A:middle
Write permissions do not
imply read permissions.

00:03:43.286 --> 00:03:45.726 A:middle
However, there's an important
exception to that point.

00:03:46.486 --> 00:03:47.866 A:middle
If your app has write
permissions

00:03:47.866 --> 00:03:50.246 A:middle
for a HealthKit type, then
you can read back data

00:03:50.246 --> 00:03:53.456 A:middle
that your app has written, just
not data from other sources.

00:03:55.436 --> 00:03:58.476 A:middle
Finally, if the user denies you
both read and write permissions

00:03:58.476 --> 00:04:01.436 A:middle
for a given type, then you can
neither query nor save data

00:04:01.436 --> 00:04:01.956 A:middle
for that type.

00:04:02.666 --> 00:04:03.906 A:middle
And there's an important
implication

00:04:03.906 --> 00:04:05.046 A:middle
of that last point as well.

00:04:05.316 --> 00:04:08.276 A:middle
If the user denies you a
previously granted write

00:04:08.276 --> 00:04:09.236 A:middle
permission for that app,

00:04:09.676 --> 00:04:11.966 A:middle
then that means your app
can no longer read any data

00:04:11.966 --> 00:04:13.106 A:middle
from HealthKit for that type,

00:04:13.526 --> 00:04:15.706 A:middle
even data that your
app previously wrote,

00:04:15.916 --> 00:04:17.036 A:middle
so keep that in mind.

00:04:18.936 --> 00:04:22.756 A:middle
So that was all technically
review,

00:04:23.046 --> 00:04:25.456 A:middle
but there is one important
change to authorizations

00:04:25.456 --> 00:04:27.626 A:middle
in general in iOS 10,
and that has to do

00:04:27.626 --> 00:04:28.826 A:middle
with usage descriptions.

00:04:30.226 --> 00:04:33.776 A:middle
Apps linked on or after iOS
10 must include a description

00:04:33.776 --> 00:04:36.176 A:middle
for the user of why they're
trying to access health data.

00:04:36.776 --> 00:04:39.616 A:middle
This reinforces our principle
of user control over data.

00:04:41.466 --> 00:04:43.536 A:middle
These usage descriptions
should be declared

00:04:43.536 --> 00:04:45.956 A:middle
on your app's info.plist
file as values

00:04:45.956 --> 00:04:48.316 A:middle
for the
NSHealthShareUsageDescription

00:04:48.316 --> 00:04:49.606 A:middle
key if you're reading data

00:04:49.716 --> 00:04:52.386 A:middle
or the
NSHealthUpdateUsageDescription

00:04:52.386 --> 00:04:53.536 A:middle
key if you're writing data.

00:04:54.116 --> 00:04:58.856 A:middle
As a refresher, this is how
you request authorization.

00:04:59.246 --> 00:05:02.196 A:middle
The first thing we
want to do is make sure

00:05:02.196 --> 00:05:04.156 A:middle
that HealthKit is even
available on the current device.

00:05:04.156 --> 00:05:05.646 A:middle
For instance, maybe
this instance

00:05:05.646 --> 00:05:08.076 A:middle
of our app is running
on an iPad.

00:05:08.076 --> 00:05:10.346 A:middle
After we've established
that, we list the types

00:05:10.346 --> 00:05:11.906 A:middle
that we're interested
in reading and writing.

00:05:12.946 --> 00:05:15.006 A:middle
And finally, we call
request authorization

00:05:15.006 --> 00:05:17.816 A:middle
on HK Health Store, pass in
the types we're interested in,

00:05:17.846 --> 00:05:19.516 A:middle
and then handle the
response and the callback.

00:05:20.106 --> 00:05:25.136 A:middle
What if you have a watchOS app?

00:05:25.276 --> 00:05:27.746 A:middle
Authorizations are shared
between your iOS app

00:05:27.746 --> 00:05:29.206 A:middle
and its companion watchOS app,

00:05:29.616 --> 00:05:31.766 A:middle
and you can request
authorization at any time

00:05:31.766 --> 00:05:33.696 A:middle
from your iOS code
or your watchOS code.

00:05:34.506 --> 00:05:37.216 A:middle
However, the system
authorization UI can only be

00:05:37.216 --> 00:05:38.826 A:middle
presented to the
user on the phone,

00:05:39.186 --> 00:05:41.356 A:middle
so this has some important
usability implications.

00:05:42.736 --> 00:05:45.456 A:middle
For instance, if the user
is about to start a workout,

00:05:45.586 --> 00:05:47.856 A:middle
they might already have their
phone wrapped up in an armband,

00:05:47.856 --> 00:05:48.786 A:middle
and if that's the case,

00:05:49.326 --> 00:05:51.706 A:middle
they can't really easily
approve an authorization request

00:05:51.706 --> 00:05:53.836 A:middle
from your app, so this
may not be the best time

00:05:53.836 --> 00:05:55.456 A:middle
to request initial
authorization.

00:05:57.126 --> 00:05:59.146 A:middle
But there's an even
more important case.

00:05:59.706 --> 00:06:02.696 A:middle
If the user's using a Watch app,
their phone may not be nearby

00:06:02.696 --> 00:06:04.006 A:middle
at all, and if that's the case,

00:06:04.166 --> 00:06:06.326 A:middle
the authorization sheet
can't even be shown.

00:06:07.066 --> 00:06:09.736 A:middle
So we really recommend you
consider these important cases

00:06:09.736 --> 00:06:12.296 A:middle
when you're developing
your Watch app.

00:06:12.496 --> 00:06:14.556 A:middle
Also remember that
the response time

00:06:14.556 --> 00:06:17.056 A:middle
for the request authorization
call is not guaranteed,

00:06:17.106 --> 00:06:19.726 A:middle
so definitely don't block
any UI while you're waiting

00:06:19.806 --> 00:06:23.346 A:middle
for a response.

00:06:24.356 --> 00:06:25.906 A:middle
So clearly it's important

00:06:25.906 --> 00:06:28.096 A:middle
to get the authorization
user experience right,

00:06:28.566 --> 00:06:31.966 A:middle
and on top of that, your app
may be requesting access to some

00:06:32.216 --> 00:06:33.946 A:middle
or even many HealthKit
data types,

00:06:34.276 --> 00:06:36.236 A:middle
so that all raises a
really important question.

00:06:36.806 --> 00:06:38.916 A:middle
When should I be
requesting access to some

00:06:38.916 --> 00:06:40.146 A:middle
or all of these types?

00:06:41.556 --> 00:06:43.476 A:middle
Here are our recommendations
on that front.

00:06:44.436 --> 00:06:46.856 A:middle
First, we recommend
that you request access

00:06:46.916 --> 00:06:49.666 A:middle
to sensible groupings
of types that correspond

00:06:49.666 --> 00:06:51.536 A:middle
to logical activities
in your application.

00:06:52.616 --> 00:06:54.816 A:middle
So for instance, say
your app allows users

00:06:54.816 --> 00:06:56.506 A:middle
to track both food
intake as well

00:06:56.506 --> 00:06:58.466 A:middle
as body measurements like BMI.

00:06:58.866 --> 00:07:01.446 A:middle
If that's the case, you might
consider requesting access

00:07:01.476 --> 00:07:04.546 A:middle
to nutrition types the first
time the user tries to log food,

00:07:04.856 --> 00:07:06.056 A:middle
but then requesting access

00:07:06.056 --> 00:07:08.356 A:middle
to body measurement types
whenever the user tries

00:07:08.356 --> 00:07:12.396 A:middle
to log one of those.

00:07:12.396 --> 00:07:13.696 A:middle
One exception to that rule is

00:07:13.696 --> 00:07:15.206 A:middle
if your app has an
on-boarding flow.

00:07:15.756 --> 00:07:18.066 A:middle
If this is the case, it
might actually make sense

00:07:18.066 --> 00:07:20.856 A:middle
to request access to all
the types your app wants

00:07:20.856 --> 00:07:23.796 A:middle
to use upfront because
you're already in a context

00:07:23.796 --> 00:07:26.726 A:middle
where you can clearly explain to
the user what your app is going

00:07:26.726 --> 00:07:27.876 A:middle
to be doing with those types.

00:07:29.536 --> 00:07:32.326 A:middle
Regardless of which you
choose, we definitely recommend

00:07:32.326 --> 00:07:34.246 A:middle
that you frequently
test authorization

00:07:34.246 --> 00:07:34.996 A:middle
during development.

00:07:35.686 --> 00:07:38.266 A:middle
You can easily reset the
initial authorization flow

00:07:38.266 --> 00:07:40.356 A:middle
by deleting your app
off of the device or out

00:07:40.356 --> 00:07:42.956 A:middle
of the simulator before
building and running again

00:07:43.266 --> 00:07:44.826 A:middle
so that HealthKit
presents the user

00:07:44.826 --> 00:07:47.066 A:middle
with the initial authorization
flow all over again.

00:07:48.236 --> 00:07:51.476 A:middle
When you're doing this,
be sure to test cases

00:07:51.476 --> 00:07:53.266 A:middle
where authorization
is either delayed

00:07:53.266 --> 00:07:54.916 A:middle
or completely denied
by the user.

00:07:55.506 --> 00:07:57.276 A:middle
How does your app
function in these cases?

00:07:57.766 --> 00:07:59.236 A:middle
What capabilities are left over?

00:08:01.036 --> 00:08:03.386 A:middle
Finally, if we could
summarize authorization

00:08:03.386 --> 00:08:04.646 A:middle
in one sentence, it's this.

00:08:05.676 --> 00:08:07.216 A:middle
Consider the user experience.

00:08:08.106 --> 00:08:10.466 A:middle
Don't present obstacles
at inopportune times,

00:08:10.466 --> 00:08:16.276 A:middle
and ensure that your
flows make sense.

00:08:16.456 --> 00:08:19.266 A:middle
So we've spent a lot of time
talking about authorization.

00:08:19.406 --> 00:08:21.616 A:middle
Now let's move onto some
new features since last year

00:08:21.616 --> 00:08:23.636 A:middle
in HealthKit, starting
with Activity Rings.

00:08:26.106 --> 00:08:28.906 A:middle
Apple's developed a great health

00:08:28.906 --> 00:08:31.216 A:middle
and fitness tracking
experience for the Apple Watch.

00:08:31.986 --> 00:08:35.136 A:middle
Users love how easy it is to
track key activity metrics

00:08:35.136 --> 00:08:38.496 A:middle
and improve their day, and
now in iOS 10 and watchOS 3,

00:08:38.496 --> 00:08:40.636 A:middle
users can even share
their Activity Rings

00:08:40.636 --> 00:08:41.886 A:middle
with each other and compete.

00:08:43.726 --> 00:08:45.366 A:middle
Now we're giving you a great way

00:08:45.546 --> 00:08:47.976 A:middle
to incorporate this Activity
Ring experience right

00:08:47.976 --> 00:08:51.706 A:middle
into your app with the
Activity Rings API in iOS 9.3.

00:08:52.366 --> 00:08:57.506 A:middle
To do this, we start with
an HKActivitySummary object.

00:08:59.636 --> 00:09:03.776 A:middle
HKActivitySummary represents
the sum of a user's activity

00:09:03.776 --> 00:09:05.066 A:middle
over the course of a given day.

00:09:05.636 --> 00:09:09.416 A:middle
That includes their move
calories, exercise minutes,

00:09:09.916 --> 00:09:13.986 A:middle
and stand hours, and
their goals for each.

00:09:15.136 --> 00:09:18.846 A:middle
HKActivitySummary is a
distinct type for authorization.

00:09:19.446 --> 00:09:22.216 A:middle
It's not an HKObject, but
rather a special read-only type

00:09:22.276 --> 00:09:24.436 A:middle
that you request
authorization for distinctly

00:09:24.436 --> 00:09:25.536 A:middle
from its component types.

00:09:26.816 --> 00:09:28.156 A:middle
That last part's
really important.

00:09:29.686 --> 00:09:33.016 A:middle
HKActivitySummary covers some of
the same HealthKit information

00:09:33.016 --> 00:09:36.596 A:middle
as the HealthKit types; active
energy, exercise minutes,

00:09:36.686 --> 00:09:41.096 A:middle
and stand hours, but only
on a daily aggregated basis.

00:09:41.276 --> 00:09:44.786 A:middle
So for instance, if you want
to do something more specific

00:09:45.256 --> 00:09:49.146 A:middle
like contribute to a
user's Move ring by writing

00:09:49.146 --> 00:09:52.836 A:middle
to the active energy type or
shown finer grain statistics

00:09:52.836 --> 00:09:55.846 A:middle
for activity over the course
of a given day, in that case,

00:09:55.846 --> 00:09:57.196 A:middle
you'd want to request access

00:09:57.196 --> 00:09:59.016 A:middle
to the constituent
types separately.

00:10:01.046 --> 00:10:04.156 A:middle
Now, because an ActivitySummary
object represents activity

00:10:04.156 --> 00:10:06.376 A:middle
over the course of a given
calendar day, which may

00:10:06.376 --> 00:10:09.396 A:middle
or may not correspond to a
particular 24-hour period,

00:10:10.056 --> 00:10:11.656 A:middle
we specify the day corresponding

00:10:11.656 --> 00:10:14.346 A:middle
to an activity summary using
a DateComponents object.

00:10:15.146 --> 00:10:16.996 A:middle
Let's see how that works
in the following example.

00:10:17.356 --> 00:10:25.076 A:middle
So suppose we want to fetch
the activity summary for today.

00:10:25.636 --> 00:10:28.396 A:middle
To do that, we use an
HKActivitySummaryQuery.

00:10:29.986 --> 00:10:31.566 A:middle
First, we use our calendar

00:10:31.676 --> 00:10:33.936 A:middle
to create a DateComponents
object corresponding

00:10:33.936 --> 00:10:36.516 A:middle
to today using the
required components;

00:10:36.976 --> 00:10:39.626 A:middle
era, year, month, and day.

00:10:41.296 --> 00:10:44.146 A:middle
Next, we use those components
to create a predicate object

00:10:44.236 --> 00:10:45.516 A:middle
that restricts our query

00:10:45.816 --> 00:10:48.486 A:middle
to activity summaries whose
day corresponds to today.

00:10:49.166 --> 00:10:52.946 A:middle
And then finally, we create our
query, pass in the predicate,

00:10:53.236 --> 00:10:56.066 A:middle
and then handle the, in this
case, single activity summary

00:10:56.066 --> 00:10:57.506 A:middle
that should come
back in the response.

00:10:58.176 --> 00:11:03.426 A:middle
So that's how you retrieve
activity summary data,

00:11:03.426 --> 00:11:05.836 A:middle
but the really fun part is
showing the rings themselves.

00:11:06.146 --> 00:11:09.196 A:middle
To do that, we use
HKActivityRingView on iOS

00:11:09.196 --> 00:11:12.916 A:middle
or the analogous
WKInterfaceActivityRing

00:11:13.126 --> 00:11:13.896 A:middle
on watchOS.

00:11:14.756 --> 00:11:17.136 A:middle
They look like this, and
just like you'd expect,

00:11:17.326 --> 00:11:18.756 A:middle
they perform this
great animation

00:11:18.916 --> 00:11:21.316 A:middle
when you call
setActivitySummary, animated.

00:11:21.846 --> 00:11:27.146 A:middle
Some tips for using
HKActivityRingView

00:11:27.146 --> 00:11:28.916 A:middle
and WKInterfaceActivityRing.

00:11:30.316 --> 00:11:33.196 A:middle
Firstly, just like in the
health and activity apps on iOS

00:11:33.196 --> 00:11:36.546 A:middle
and watchOS, the rings look
best on a black background,

00:11:36.576 --> 00:11:38.996 A:middle
so we recommend display
them similarly in your apps.

00:11:41.096 --> 00:11:42.786 A:middle
Secondly, if your
app has sharing

00:11:42.786 --> 00:11:45.826 A:middle
and communication features, you
can use the writable properties

00:11:45.826 --> 00:11:48.846 A:middle
of HKActivitySummary to
construct your own object,

00:11:49.206 --> 00:11:53.146 A:middle
supply it to HKActivityRingView
or WKInterfaceActivityRing,

00:11:53.566 --> 00:11:56.156 A:middle
and thereby display another
user's rings alongside the

00:11:56.156 --> 00:11:59.606 A:middle
current user's rings
in your own app.

00:12:00.456 --> 00:12:03.106 A:middle
Finally, when you're using
HKActivitySummaryQuery,

00:12:03.106 --> 00:12:06.366 A:middle
remember to use the required
DateComponents; era, year,

00:12:06.486 --> 00:12:09.346 A:middle
month, and day in your
HKActivitySummaryQuery.

00:12:11.236 --> 00:12:12.866 A:middle
Date map can be notoriously
tricky,

00:12:12.936 --> 00:12:15.566 A:middle
so if you have any
questions about using Calendar

00:12:15.566 --> 00:12:17.906 A:middle
or DateComponents, be sure
to check out this great talk

00:12:17.966 --> 00:12:23.046 A:middle
from a prior conference.

00:12:23.046 --> 00:12:24.066 A:middle
So we've been talking a lot

00:12:24.066 --> 00:12:25.766 A:middle
about authorization
and Activity Rings.

00:12:25.766 --> 00:12:27.586 A:middle
Let's put it into
action with a quick demo.

00:12:28.636 --> 00:12:31.016 A:middle
Here on the right, we
have an up and coming app

00:12:31.016 --> 00:12:32.596 A:middle
for a medical group
called LoopHealth.

00:12:33.346 --> 00:12:34.716 A:middle
This app has some
other features,

00:12:34.716 --> 00:12:37.626 A:middle
but its main page is a dashboard
with some helpful information,

00:12:37.626 --> 00:12:41.016 A:middle
so for instance, your doctor's
name, upcoming appointments,

00:12:41.256 --> 00:12:42.176 A:middle
and some healthy tips.

00:12:43.716 --> 00:12:46.906 A:middle
LoopHealth wants their patients
to live healthier daily lives

00:12:46.906 --> 00:12:48.976 A:middle
as well, so they saw this
as a great opportunity

00:12:48.976 --> 00:12:50.986 A:middle
to incorporate Apple's
Activity Rings right

00:12:50.986 --> 00:12:51.876 A:middle
onto their dashboard.

00:12:52.336 --> 00:12:53.676 A:middle
As you can see here,

00:12:53.676 --> 00:12:56.156 A:middle
we've already dropped
an HKActivityRingView

00:12:56.156 --> 00:12:58.006 A:middle
into the storyboard
for our application,

00:12:58.306 --> 00:12:59.616 A:middle
but we haven't actually
written the code

00:12:59.616 --> 00:13:00.866 A:middle
that hooks it up with data yet.

00:13:01.136 --> 00:13:02.446 A:middle
Let's see how easy
it is to do that.

00:13:03.146 --> 00:13:06.196 A:middle
So over here in Xcode, we
have DashboardViewController.

00:13:06.196 --> 00:13:07.906 A:middle
This is the view controller
we were just looking

00:13:07.906 --> 00:13:09.566 A:middle
at in the LoopHealth app.

00:13:10.216 --> 00:13:11.566 A:middle
It's pretty empty so far,

00:13:12.046 --> 00:13:13.876 A:middle
but we do have some
helpful things filled in.

00:13:14.746 --> 00:13:17.766 A:middle
You can see right here we have
an IBOutlet set up connected

00:13:17.826 --> 00:13:19.856 A:middle
to the activityRingView
that's already in our app.

00:13:21.276 --> 00:13:23.316 A:middle
Up here we import HealthKitUI.

00:13:23.526 --> 00:13:24.996 A:middle
This is the new framework

00:13:24.996 --> 00:13:27.796 A:middle
that you can find
HKActivityRingView in on iOS.

00:13:29.316 --> 00:13:32.106 A:middle
And finally down
here, LoopHealth sets

00:13:32.106 --> 00:13:34.656 A:middle
up its app-wide HKHealthStore
in its app delegate,

00:13:34.726 --> 00:13:37.556 A:middle
so we've just set up a simple
computed property to retrieve it

00:13:37.556 --> 00:13:40.656 A:middle
for convenience when we need it.

00:13:41.416 --> 00:13:44.276 A:middle
Okay, so if we want to show an
activity summary in our app,

00:13:44.346 --> 00:13:47.026 A:middle
the first thing we need to
do is request read access

00:13:47.026 --> 00:13:48.286 A:middle
to HKActivitySummary.

00:13:49.366 --> 00:13:51.746 A:middle
And since we're reading health
data, that means we need

00:13:51.746 --> 00:13:53.156 A:middle
to include a usage description,

00:13:53.386 --> 00:13:57.376 A:middle
so let's go to our info.plist
file and add a new key.

00:13:58.666 --> 00:13:59.986 A:middle
The key we're interested

00:13:59.986 --> 00:14:02.466 A:middle
in is called NSHealthShare
UsageDescription,

00:14:02.466 --> 00:14:05.536 A:middle
which is written here in plain
English as Privacy Health Share.

00:14:09.156 --> 00:14:11.406 A:middle
Perfect. And I'll drop

00:14:11.406 --> 00:14:13.946 A:middle
in a quick usage
description, and that's it.

00:14:13.946 --> 00:14:14.516 A:middle
We're all set.

00:14:15.876 --> 00:14:17.966 A:middle
Now I can go back to
DashboardViewController

00:14:17.966 --> 00:14:20.466 A:middle
and then write the code that
actually requests authorization.

00:14:21.946 --> 00:14:24.906 A:middle
Since we want to show the
initial prompt to the user

00:14:24.906 --> 00:14:27.286 A:middle
and also update our rings
whenever the user navigates

00:14:27.286 --> 00:14:29.616 A:middle
to the dashboard tab, the
perfect place to do that is

00:14:29.616 --> 00:14:31.206 A:middle
in the viewDidAppear method.

00:14:32.386 --> 00:14:34.426 A:middle
So I'll drop that in here.

00:14:34.426 --> 00:14:37.676 A:middle
And after our requisite
call to super,

00:14:37.676 --> 00:14:39.656 A:middle
notice that we call
RequestAuthorization

00:14:39.656 --> 00:14:43.146 A:middle
on HKHealthStore, pass in
the activity summary type,

00:14:43.146 --> 00:14:46.976 A:middle
and then in the response, we
call updateActivitySummary,

00:14:47.806 --> 00:14:50.126 A:middle
which we'll write to actually
fetch and update the data.

00:14:50.386 --> 00:14:51.416 A:middle
Let's go implement that now.

00:14:53.036 --> 00:14:58.496 A:middle
So here's our skeleton
for updateActivitySummary,

00:14:58.496 --> 00:15:01.306 A:middle
and what we want to
do here is create an

00:15:01.306 --> 00:15:05.946 A:middle
HKActivitySummaryQuery, request
today's activity summary,

00:15:05.996 --> 00:15:07.646 A:middle
and then set that
activity summary

00:15:07.646 --> 00:15:10.376 A:middle
on our HKActivityRingView
once we get it back.

00:15:11.916 --> 00:15:13.846 A:middle
First, let's create a
DateComponents object

00:15:13.846 --> 00:15:14.876 A:middle
corresponding to today.

00:15:15.416 --> 00:15:18.866 A:middle
Since DateComponents only
makes sense in the context

00:15:18.866 --> 00:15:21.356 A:middle
of a particular calendar,
we set the calendar object

00:15:21.356 --> 00:15:24.376 A:middle
that we use back on
the components object.

00:15:26.216 --> 00:15:27.466 A:middle
Oops, perfect.

00:15:28.496 --> 00:15:30.376 A:middle
Next, we can create
our predicate using

00:15:30.376 --> 00:15:34.656 A:middle
that components object, and
once we have the predicate,

00:15:34.856 --> 00:15:37.516 A:middle
we can create our query,
pass in the predicate,

00:15:37.516 --> 00:15:40.866 A:middle
and then in the response,
we grab the single summary

00:15:40.866 --> 00:15:42.056 A:middle
that should come back for today.

00:15:44.666 --> 00:15:46.236 A:middle
Now, once we have that summary,

00:15:46.356 --> 00:15:48.776 A:middle
all we have to do is dispatch
back to the main queue

00:15:48.776 --> 00:15:53.606 A:middle
to update our UI and then
call setActivitySummary,

00:15:53.926 --> 00:15:56.236 A:middle
animated on our Activity
Ring view.

00:15:58.036 --> 00:15:59.836 A:middle
Now that we have our
query, all we have left

00:15:59.836 --> 00:16:04.826 A:middle
to do is execute
it, and that's it.

00:16:05.506 --> 00:16:07.876 A:middle
So let's build and run and
see how this all looks.

00:16:23.836 --> 00:16:24.356 A:middle
Excellent.

00:16:24.356 --> 00:16:27.086 A:middle
So first thing you see is now
that we're requesting access

00:16:27.086 --> 00:16:29.816 A:middle
to activity summary,
Health is asking the user

00:16:29.816 --> 00:16:31.146 A:middle
to approve authorization.

00:16:33.486 --> 00:16:35.756 A:middle
Let's approve read access
for our activity type,

00:16:35.756 --> 00:16:37.666 A:middle
and while we're down there,
notice that at the bottom

00:16:37.666 --> 00:16:39.536 A:middle
of the screen, that usage
description that we added

00:16:39.536 --> 00:16:42.116 A:middle
for reading health data is
included and shown to the user.

00:16:42.716 --> 00:16:44.506 A:middle
It's important to note
that in a real app,

00:16:44.506 --> 00:16:46.406 A:middle
we'd want to make sure this
description is localized,

00:16:46.446 --> 00:16:49.426 A:middle
so we'd include that in our
info.plist.strings file instead.

00:16:51.996 --> 00:16:56.616 A:middle
I'll approve authorization
here, and just like that,

00:16:56.616 --> 00:16:59.836 A:middle
we see the Activity Rings
animate beautifully into place.

00:17:00.516 --> 00:17:06.500 A:middle
[ Applause ]

00:17:09.226 --> 00:17:10.276 A:middle
So that's how easy it is

00:17:10.276 --> 00:17:12.386 A:middle
to incorporate Activity Rings
right into your own app.

00:17:12.536 --> 00:17:13.736 A:middle
Be sure to check out the API.

00:17:14.756 --> 00:17:17.136 A:middle
Next, I'll turn it over to
my colleague Jeff who's going

00:17:17.136 --> 00:17:19.636 A:middle
to tell you about an awesome
new feature in iOS 10.

00:17:20.516 --> 00:17:25.626 A:middle
[ Applause ]

00:17:26.126 --> 00:17:26.656 A:middle
&gt;&gt; Thanks, Matt.

00:17:27.286 --> 00:17:28.156 A:middle
Good morning, everyone.

00:17:28.746 --> 00:17:30.186 A:middle
My name is Joefrey Kibuule.

00:17:30.726 --> 00:17:33.366 A:middle
I work alongside Matt as
an iOS software engineer

00:17:33.406 --> 00:17:34.126 A:middle
on the Health team.

00:17:35.006 --> 00:17:37.246 A:middle
Today I have the proud
privilege to introduce

00:17:37.246 --> 00:17:40.426 A:middle
to you a new feature of
iOS 10, Health Records.

00:17:41.456 --> 00:17:44.006 A:middle
Health Records provides
an easy and portable way

00:17:44.006 --> 00:17:45.966 A:middle
to carry the information
most personal

00:17:45.966 --> 00:17:48.286 A:middle
to you right on your smartphone.

00:17:50.056 --> 00:17:52.036 A:middle
Today the current experience

00:17:52.166 --> 00:17:55.446 A:middle
when users visit a medical
professional and ask

00:17:55.446 --> 00:17:57.716 A:middle
for their health records
afterwards is this.

00:17:58.866 --> 00:18:01.036 A:middle
A stack of documents
which may be cumbersome

00:18:01.326 --> 00:18:03.666 A:middle
to find a particular
piece of information.

00:18:05.426 --> 00:18:06.296 A:middle
More recently,

00:18:06.296 --> 00:18:09.356 A:middle
health organizations have been
providing their patients this.

00:18:10.366 --> 00:18:15.186 A:middle
CDs of digitized information
which may be unintuitive to use.

00:18:17.016 --> 00:18:19.646 A:middle
But now with Health
Records in iOS,

00:18:20.056 --> 00:18:21.476 A:middle
we can help solve this problem.

00:18:23.756 --> 00:18:26.036 A:middle
Through the work that
we've done in this release,

00:18:26.386 --> 00:18:29.026 A:middle
your apps can start to
unlock new possibilities

00:18:29.696 --> 00:18:32.056 A:middle
in the exchange and
interaction of Health Records.

00:18:32.716 --> 00:18:37.016 A:middle
In fact, in the U.S., adoption

00:18:37.016 --> 00:18:39.756 A:middle
of these APIs can help
health organizations comply

00:18:39.796 --> 00:18:42.346 A:middle
with new regulations
that require them

00:18:42.346 --> 00:18:44.276 A:middle
to give their patients
more control

00:18:44.276 --> 00:18:48.066 A:middle
of their own health data.

00:18:48.246 --> 00:18:49.886 A:middle
So first, an overview.

00:18:50.676 --> 00:18:53.626 A:middle
Health Records in iOS is
an umbrella term we use

00:18:53.736 --> 00:18:55.026 A:middle
to represent a variety

00:18:55.026 --> 00:18:57.076 A:middle
of different patient
visits generated

00:18:57.076 --> 00:18:58.326 A:middle
by health institutions.

00:19:00.016 --> 00:19:02.036 A:middle
Today we're adding
support specifically

00:19:02.036 --> 00:19:03.176 A:middle
for health documents.

00:19:04.696 --> 00:19:06.916 A:middle
Standard machine-readable XML

00:19:06.916 --> 00:19:08.926 A:middle
that represents specific
patient visits.

00:19:10.176 --> 00:19:12.796 A:middle
These include patient
visit summaries,

00:19:13.606 --> 00:19:15.086 A:middle
continuity of care visits,

00:19:15.576 --> 00:19:19.626 A:middle
and operative notes,
just to name a few.

00:19:19.986 --> 00:19:23.206 A:middle
We support the international
HL-7 CDA standard

00:19:23.206 --> 00:19:26.116 A:middle
for interoperability with a
variety of different providers.

00:19:28.276 --> 00:19:29.886 A:middle
These documents are available

00:19:29.886 --> 00:19:31.696 A:middle
through patient healthcare
portals online

00:19:31.766 --> 00:19:38.496 A:middle
and can be imported via Safari,
Mail, and now all of your apps.

00:19:39.796 --> 00:19:41.716 A:middle
These documents are stored just

00:19:41.716 --> 00:19:45.056 A:middle
like all other HealthKit
data safely

00:19:45.056 --> 00:19:49.996 A:middle
and securely encrypted
on your iOS device.

00:19:50.156 --> 00:19:51.966 A:middle
Next, let's talk
about permissions.

00:19:53.256 --> 00:19:55.386 A:middle
Since so much information
is contained

00:19:55.386 --> 00:19:56.626 A:middle
within each health document,

00:19:57.026 --> 00:19:59.476 A:middle
we give the user
additional controls compared

00:19:59.476 --> 00:20:01.626 A:middle
to other data types
in HealthKit.

00:20:03.046 --> 00:20:06.416 A:middle
Access is granted on a
per-document basis in addition

00:20:06.416 --> 00:20:10.156 A:middle
to the health document
data type.

00:20:10.356 --> 00:20:13.436 A:middle
As shown on the right, we
present the UI in order

00:20:13.436 --> 00:20:15.126 A:middle
to allow the user to both view

00:20:15.126 --> 00:20:17.946 A:middle
and select the document before
granting your app access.

00:20:19.716 --> 00:20:23.016 A:middle
This UI will present it whenever
you query for a document

00:20:23.066 --> 00:20:24.426 A:middle
and a new one is available.

00:20:25.706 --> 00:20:29.206 A:middle
If you query for documents and
none are, nothing has changed,

00:20:30.176 --> 00:20:32.836 A:middle
we will not show
this UI to the user

00:20:32.916 --> 00:20:35.586 A:middle
and your query will return
immediately with results.

00:20:41.296 --> 00:20:43.876 A:middle
If you query for documents
while your application is

00:20:43.876 --> 00:20:47.676 A:middle
in the background, we will
never prompt the user UI

00:20:47.676 --> 00:20:49.486 A:middle
to grant access to
new documents.

00:20:50.166 --> 00:20:52.636 A:middle
HealthKit ensures that
the user is always aware

00:20:52.636 --> 00:20:54.296 A:middle
when they're granting
access to documents

00:20:54.296 --> 00:20:56.506 A:middle
to your apps the
first time it occurs.

00:20:57.096 --> 00:21:02.076 A:middle
Next, let's talk about how to
create a document in HealthKit.

00:21:04.336 --> 00:21:06.326 A:middle
When saving a document
into HealthKit,

00:21:06.326 --> 00:21:07.786 A:middle
you can save the raw XML

00:21:07.786 --> 00:21:11.056 A:middle
into the new HKCDADocumentSample
type.

00:21:12.716 --> 00:21:15.416 A:middle
We validate on creation
to ensure compliance

00:21:15.416 --> 00:21:21.316 A:middle
with the standard and will
throw errors if this fails.

00:21:21.886 --> 00:21:26.266 A:middle
We automatically extract the
title, patient, custodian,

00:21:26.266 --> 00:21:28.976 A:middle
and author names whenever the
document is saved into HealthKit

00:21:29.366 --> 00:21:32.226 A:middle
in order to make querying
for these fields faster

00:21:32.536 --> 00:21:34.336 A:middle
without needing to read
the entire document.

00:21:34.826 --> 00:21:38.206 A:middle
Let's take a look at
this example in code.

00:21:38.206 --> 00:21:40.356 A:middle
We're going to take
the documentData

00:21:40.356 --> 00:21:42.146 A:middle
and transform it
into a data object.

00:21:42.736 --> 00:21:44.816 A:middle
The origin of this XML
will typically come

00:21:44.816 --> 00:21:46.336 A:middle
from a health organization
server.

00:21:47.726 --> 00:21:51.236 A:middle
We're then going to create a
new HKCDADocumentSample passing

00:21:51.276 --> 00:21:54.566 A:middle
in that data object, setting
the appropriate dates,

00:21:55.186 --> 00:21:58.366 A:middle
and any additional metadata,
just like any other HKSample.

00:21:58.366 --> 00:22:02.186 A:middle
And then we'll save the
document to the healthStore.

00:22:02.886 --> 00:22:03.506 A:middle
That's it.

00:22:03.996 --> 00:22:07.046 A:middle
Now your health document is
saved into HealthKit ready

00:22:07.046 --> 00:22:09.286 A:middle
to be used in other
apps or viewed directly

00:22:09.286 --> 00:22:13.186 A:middle
by the user in the Health App.

00:22:13.456 --> 00:22:16.156 A:middle
Now, let's talk about querying
for documents in HealthKit.

00:22:17.656 --> 00:22:21.616 A:middle
Since HKCDADocumentSample
is a subclass of HKSample,

00:22:22.436 --> 00:22:24.836 A:middle
existing query objects you
may be already familiar

00:22:24.836 --> 00:22:27.046 A:middle
with continue to work
just as you'd expect.

00:22:28.336 --> 00:22:30.866 A:middle
However, you need to use
the new HKDocumentQuery

00:22:30.866 --> 00:22:32.486 A:middle
in order to fetch the raw XML.

00:22:33.016 --> 00:22:35.456 A:middle
Fetching the raw XML's
expensive, and we only do

00:22:35.456 --> 00:22:37.766 A:middle
so when explicitly specified.

00:22:39.616 --> 00:22:42.726 A:middle
We provide predicate
support in order to query

00:22:42.726 --> 00:22:48.596 A:middle
for the automatically extracted
fields, and then lastly,

00:22:48.596 --> 00:22:52.546 A:middle
to remember that since
HKDocumentSamples are immutable,

00:22:52.546 --> 00:22:53.466 A:middle
updated information

00:22:53.466 --> 00:22:56.546 A:middle
to previously samples are
considered new samples.

00:22:56.546 --> 00:23:01.346 A:middle
Now, let's take a look at
an example of how to query

00:23:01.346 --> 00:23:02.526 A:middle
for documents in HealthKit.

00:23:02.916 --> 00:23:04.416 A:middle
In this example,
we're going to query

00:23:04.416 --> 00:23:06.486 A:middle
for all the documents
a user has stored.

00:23:07.636 --> 00:23:09.776 A:middle
So first, we need to
get the document type.

00:23:09.906 --> 00:23:12.326 A:middle
We're going to pass
the CDA identifier

00:23:12.326 --> 00:23:14.706 A:middle
into the document type
forIdentifier method

00:23:14.706 --> 00:23:15.866 A:middle
on HKObjectType.

00:23:18.456 --> 00:23:20.556 A:middle
We're then going to
create an HKDocumentQuery.

00:23:21.406 --> 00:23:23.216 A:middle
You have additional
fields in order to filter

00:23:23.216 --> 00:23:25.146 A:middle
and order the documents
received back

00:23:25.146 --> 00:23:26.786 A:middle
to you the order
that you'd like.

00:23:27.566 --> 00:23:30.276 A:middle
And then we execute
the query in order

00:23:30.276 --> 00:23:33.026 A:middle
to get the HKCDADocumentSamples
back from HealthKit.

00:23:33.556 --> 00:23:38.166 A:middle
One thing I want to note in
this particular example we set

00:23:38.166 --> 00:23:40.086 A:middle
includeDocumentData to false.

00:23:40.276 --> 00:23:41.966 A:middle
Only ever set it to true

00:23:41.966 --> 00:23:47.556 A:middle
if you need the full
raw XML document data.

00:23:47.736 --> 00:23:50.346 A:middle
Now, let's talk about some
best practices when dealing

00:23:50.346 --> 00:23:52.296 A:middle
with the health documents
in HealthKit.

00:23:53.516 --> 00:23:56.796 A:middle
First, check for validation
errors whenever creating

00:23:56.796 --> 00:23:58.176 A:middle
and HKCDADocumentSample.

00:23:59.426 --> 00:24:01.346 A:middle
The errors will tell
you why we weren't able

00:24:01.346 --> 00:24:04.566 A:middle
to transform your raw
XML into a usable sample.

00:24:07.016 --> 00:24:09.416 A:middle
Next, you should
verify by the Health App

00:24:09.726 --> 00:24:12.816 A:middle
that you imported
were correctly saved

00:24:12.856 --> 00:24:14.946 A:middle
and automatically
extracted fields are present.

00:24:15.796 --> 00:24:17.556 A:middle
This way, you can tell
that queries based

00:24:17.556 --> 00:24:20.566 A:middle
on those automatically extracted
fields return the correct sample

00:24:20.566 --> 00:24:21.386 A:middle
that you'd expect.

00:24:23.156 --> 00:24:26.856 A:middle
And lastly, request the raw
XML data only when you need to.

00:24:27.156 --> 00:24:30.506 A:middle
Queries that don't request,
including document data,

00:24:30.976 --> 00:24:33.326 A:middle
will return the automatically
extracted fields,

00:24:33.326 --> 00:24:35.846 A:middle
and this may be all you
need for you and your users

00:24:35.846 --> 00:24:38.586 A:middle
to uniquely identify a
document in HealthKit.

00:24:40.166 --> 00:24:43.416 A:middle
For more information on
the HL-7 CDA Standard,

00:24:43.416 --> 00:24:44.696 A:middle
visit the link on the screen.

00:24:49.046 --> 00:24:50.316 A:middle
Now, I'd like to switch gears

00:24:50.316 --> 00:24:52.486 A:middle
and offer some general
guidance on handling data.

00:24:52.486 --> 00:24:58.836 A:middle
As you know, HealthKit serves
as a central repository

00:24:58.836 --> 00:25:01.956 A:middle
where your app and other
apps can help contribute

00:25:01.956 --> 00:25:03.656 A:middle
to a user's record
of health data.

00:25:05.346 --> 00:25:08.176 A:middle
Your app in cloud service may
also have a direct connection

00:25:08.176 --> 00:25:09.816 A:middle
with another app
in cloud service,

00:25:10.266 --> 00:25:12.606 A:middle
and this may require some
special considerations.

00:25:13.336 --> 00:25:16.226 A:middle
So there are three main topics
that I'd like to discuss

00:25:16.226 --> 00:25:17.616 A:middle
when talking about
handling data.

00:25:18.736 --> 00:25:20.246 A:middle
First, syncing data.

00:25:21.206 --> 00:25:23.186 A:middle
Second, tracking change data.

00:25:24.016 --> 00:25:27.396 A:middle
And third, migrating data.

00:25:27.586 --> 00:25:29.246 A:middle
So first, syncing data.

00:25:30.316 --> 00:25:32.956 A:middle
You should be using
HKAnchoredObjectQuery in order

00:25:32.956 --> 00:25:36.676 A:middle
to handle processing both new
and deleted samples in order

00:25:36.676 --> 00:25:38.666 A:middle
to keep up to date
with HealthKit.

00:25:39.576 --> 00:25:41.956 A:middle
Anchors act as a
bookmark to keep track

00:25:41.956 --> 00:25:44.276 A:middle
of the last query operation
you used to fetch data.

00:25:44.916 --> 00:25:47.056 A:middle
You could save this anchor
for the next time you need

00:25:47.056 --> 00:25:49.166 A:middle
to create a new
HKAnchoredObjectQuery.

00:25:51.656 --> 00:25:53.726 A:middle
You'll open one query
for each sample type

00:25:53.726 --> 00:25:54.606 A:middle
that you're interested in

00:25:55.516 --> 00:25:58.346 A:middle
and then pass an optional
update handler in order

00:25:58.346 --> 00:26:02.006 A:middle
to continuously process new and
deleted samples without needing

00:26:02.006 --> 00:26:03.856 A:middle
to unnecessarily
requery HealthKit.

00:26:05.116 --> 00:26:07.746 A:middle
But say for a better
user experience,

00:26:08.006 --> 00:26:09.056 A:middle
in order to have fresh UI

00:26:09.056 --> 00:26:11.176 A:middle
when your application
is first launched,

00:26:11.586 --> 00:26:15.866 A:middle
or to keep your cloud data in
sync, your application needs

00:26:15.866 --> 00:26:18.376 A:middle
to handle processing new
and deleted samples even

00:26:18.376 --> 00:26:19.486 A:middle
when it's currently not running.

00:26:20.586 --> 00:26:23.046 A:middle
That's where HKObserverQuery
working

00:26:23.046 --> 00:26:25.426 A:middle
with HKAnchoredObjectQuery
comes into play.

00:26:26.576 --> 00:26:29.036 A:middle
Let's look at an
example with a diagram.

00:26:30.596 --> 00:26:34.096 A:middle
So there are four
main steps in order

00:26:34.096 --> 00:26:35.876 A:middle
to handle background
updates split

00:26:35.876 --> 00:26:39.046 A:middle
into two phases;
setup and execution.

00:26:39.866 --> 00:26:42.026 A:middle
In the first step,
we're going to register

00:26:42.026 --> 00:26:43.126 A:middle
for background updates.

00:26:43.486 --> 00:26:45.246 A:middle
You need to do this
for every sample type

00:26:45.246 --> 00:26:46.136 A:middle
that you're interested in.

00:26:47.176 --> 00:26:50.236 A:middle
In the second step, you're
going to open an ObserverQuery.

00:26:51.236 --> 00:26:55.176 A:middle
Once set up, the ObserverQuery
will monitor for both new

00:26:55.176 --> 00:26:56.686 A:middle
and deleted samples
in HealthKit.

00:26:58.976 --> 00:27:00.736 A:middle
When new samples are generated,

00:27:00.736 --> 00:27:02.306 A:middle
that's when you have
the third step.

00:27:02.856 --> 00:27:04.716 A:middle
You'll get a callback
from the observer query

00:27:04.866 --> 00:27:07.536 A:middle
and then execute an
HKAnchoredObjectQuery in order

00:27:07.536 --> 00:27:09.386 A:middle
to fetch new and
deleted samples.

00:27:10.036 --> 00:27:12.756 A:middle
And then in the fourth step,

00:27:13.456 --> 00:27:15.956 A:middle
you'll call the observer queries
completion handler in order

00:27:15.956 --> 00:27:17.666 A:middle
to let HealthKit know
that you've processed

00:27:17.666 --> 00:27:19.146 A:middle
and delivered the
background update.

00:27:20.576 --> 00:27:23.496 A:middle
You'll then continue to cycle
between steps three and four

00:27:23.496 --> 00:27:25.246 A:middle
in order to keep up to
date with HealthKit.

00:27:25.336 --> 00:27:33.876 A:middle
Now, let's take a look at this
example one by one in code.

00:27:34.046 --> 00:27:37.336 A:middle
So in the first step, we need to
register for background updates.

00:27:37.716 --> 00:27:40.466 A:middle
Your application needs to do
this every time it's launched,

00:27:40.466 --> 00:27:41.666 A:middle
so we recommend you do it

00:27:41.666 --> 00:27:44.256 A:middle
in application
didFinishLaunching WithOptions.

00:27:45.746 --> 00:27:48.756 A:middle
You'll then grab the step's
quantity type from HKObjectType

00:27:49.486 --> 00:27:53.026 A:middle
and then pass that to HK Health
Store's enableBackgroundDelivery

00:27:53.026 --> 00:27:54.666 A:middle
for, passing in the steps type

00:27:54.666 --> 00:27:56.486 A:middle
and the frequency
you'd like updates.

00:27:57.586 --> 00:28:00.586 A:middle
Do note that background delivery
times are not guaranteed.

00:28:02.976 --> 00:28:06.366 A:middle
Your application needs to pick
the longest possible frequency

00:28:06.366 --> 00:28:07.596 A:middle
it can handle in order

00:28:07.596 --> 00:28:09.856 A:middle
to preserve a user's
device's battery life.

00:28:11.256 --> 00:28:14.156 A:middle
Also note that this
API is iOS specific.

00:28:14.586 --> 00:28:17.306 A:middle
Background updates are
not available on watchOS.

00:28:17.896 --> 00:28:22.586 A:middle
In the second step, we're going
to pass the step's quantity type

00:28:22.616 --> 00:28:25.816 A:middle
to create the HKAnchored,
the HKObserverQuery.

00:28:27.036 --> 00:28:29.826 A:middle
Here we'll have a
custom updateSteps method

00:28:30.206 --> 00:28:33.096 A:middle
that we can use in order
to know, to fetch new

00:28:33.096 --> 00:28:35.706 A:middle
and deleted samples when
HealthKit detects that.

00:28:36.366 --> 00:28:38.306 A:middle
And then we're going
to execute the query.

00:28:39.116 --> 00:28:39.686 A:middle
That's it.

00:28:39.736 --> 00:28:42.336 A:middle
That completes the setup
process in order for HealthKit

00:28:42.336 --> 00:28:44.596 A:middle
to monitor new and deleted
samples in HealthKit.

00:28:45.556 --> 00:28:50.136 A:middle
So as I'm walking across stage
generating health samples,

00:28:50.136 --> 00:28:54.486 A:middle
step samples, our,
we're going to dive

00:28:54.486 --> 00:28:57.306 A:middle
into the update steps method in
order to know what we need to do

00:28:57.306 --> 00:28:59.196 A:middle
in order to grab new
and deleted samples.

00:28:59.726 --> 00:29:02.576 A:middle
So first, we're going to create
an HKAnchoredObjectQuery,

00:29:03.076 --> 00:29:04.216 A:middle
passing in the steps type.

00:29:04.606 --> 00:29:08.066 A:middle
You'll also have predicate,
additional fields in order

00:29:08.066 --> 00:29:10.846 A:middle
to filter the particular
samples you'd like.

00:29:13.336 --> 00:29:16.656 A:middle
Then we'll call the handleSteps
method in order to process new

00:29:16.656 --> 00:29:22.666 A:middle
and deleted samples and
then update our anchor

00:29:22.666 --> 00:29:25.586 A:middle
for the next time we need to
create an HKAnchoredObjectQuery.

00:29:26.216 --> 00:29:29.436 A:middle
We then call the
completionHandler in order

00:29:29.436 --> 00:29:32.486 A:middle
to know that we've done
processing fetching new data,

00:29:32.486 --> 00:29:36.146 A:middle
and then we execute the query.

00:29:37.646 --> 00:29:39.376 A:middle
Then lastly, in step four,

00:29:39.376 --> 00:29:41.546 A:middle
we're going to call the
completionHandler given to us

00:29:41.546 --> 00:29:44.056 A:middle
from the observer query in order

00:29:44.056 --> 00:29:45.966 A:middle
to let HealthKit know
we've both received

00:29:46.016 --> 00:29:48.146 A:middle
and processed the
background update.

00:29:48.746 --> 00:29:49.576 A:middle
And that's it.

00:29:49.576 --> 00:29:52.166 A:middle
Now your application will
have a fresh UI on launch

00:29:52.336 --> 00:29:58.876 A:middle
and keep your cloud data in sync
following all of these steps.

00:29:59.056 --> 00:30:01.206 A:middle
Next, let's talk about
tracking change data.

00:30:02.156 --> 00:30:04.006 A:middle
You should be using
UUIDs in order

00:30:04.006 --> 00:30:06.126 A:middle
to keep tracking of
unique HKObjects.

00:30:08.016 --> 00:30:13.916 A:middle
A unique identifier is set
each time an object is created

00:30:13.916 --> 00:30:15.836 A:middle
and persists for the
lifetime of the sample.

00:30:17.776 --> 00:30:22.356 A:middle
Record UUIDs in your own
data store or both locally

00:30:22.356 --> 00:30:24.256 A:middle
on the device and
remotely in the cloud

00:30:24.336 --> 00:30:28.606 A:middle
so that way you could tell a
particular sample is the same.

00:30:28.806 --> 00:30:31.396 A:middle
Whenever these samples
are deleted, say,

00:30:31.396 --> 00:30:34.826 A:middle
a workout from the Health
App, you should be monitoring

00:30:34.826 --> 00:30:36.466 A:middle
for these changes to
make sure that these,

00:30:36.726 --> 00:30:39.086 A:middle
those same samples are
also deleted again locally

00:30:39.086 --> 00:30:41.746 A:middle
on the device and
remotely in the cloud.

00:30:43.646 --> 00:30:47.696 A:middle
And ensure that future sync
operations don't re-add already

00:30:47.696 --> 00:30:48.536 A:middle
deleted samples.

00:30:49.626 --> 00:30:52.596 A:middle
Now, there are two
potential problems that I'd

00:30:52.596 --> 00:30:55.196 A:middle
like to discuss when
referring talking

00:30:55.196 --> 00:30:56.796 A:middle
about how to avoid duplication.

00:30:57.556 --> 00:30:59.586 A:middle
The first is pre-populating
data.

00:30:59.976 --> 00:31:02.586 A:middle
Pre-populating data is,
I'm sorry, onboarding.

00:31:03.166 --> 00:31:05.906 A:middle
Pre-populating data is a
great way during on-boarding

00:31:05.906 --> 00:31:08.126 A:middle
to save the user time
by pulling information

00:31:08.126 --> 00:31:09.836 A:middle
that may already be
stored in HealthKit.

00:31:11.626 --> 00:31:14.916 A:middle
Users have the ability to verify
data that's already in HealthKit

00:31:14.986 --> 00:31:16.326 A:middle
and change it if necessary.

00:31:17.956 --> 00:31:20.746 A:middle
However, the problem is
saving unchanged values.

00:31:21.886 --> 00:31:25.806 A:middle
Be sure only to save data again
if this is the user's intent.

00:31:28.696 --> 00:31:32.926 A:middle
Another additional potential
problem may be ingesting data

00:31:32.996 --> 00:31:34.726 A:middle
both from another
app and HealthKit.

00:31:35.986 --> 00:31:37.956 A:middle
Remember to only pick one source

00:31:37.956 --> 00:31:40.786 A:middle
of information that's most
appropriate to your application.

00:31:41.676 --> 00:31:43.346 A:middle
HealthKit has a great
privacy story

00:31:43.346 --> 00:31:45.386 A:middle
that our users have
already bought into.

00:31:45.386 --> 00:31:50.866 A:middle
However, you know what's, what
source is best for your app.

00:31:51.146 --> 00:31:53.946 A:middle
Make sure not to save
another application's data

00:31:53.946 --> 00:31:54.896 A:middle
on their behalf.

00:31:56.346 --> 00:31:59.946 A:middle
Writing only your data once
avoids duplicating data

00:31:59.946 --> 00:32:02.746 A:middle
by simplifying which
app's responsibility it is

00:32:02.746 --> 00:32:03.246 A:middle
to write it.

00:32:04.156 --> 00:32:06.446 A:middle
There is one particular
exception for this rule.

00:32:06.476 --> 00:32:08.326 A:middle
Sometimes duplication
is intentional.

00:32:09.586 --> 00:32:11.996 A:middle
For example, if data's
coming from multiple sources.

00:32:12.716 --> 00:32:17.416 A:middle
If a data, step data is
generated both on a user's phone

00:32:17.416 --> 00:32:23.176 A:middle
and his or her Apple Watch,
you can use HKStatisticsQuery

00:32:23.206 --> 00:32:25.786 A:middle
and HKStatisticsCollectionQuery
in order

00:32:25.786 --> 00:32:28.916 A:middle
to automatically
de-duplicate data by the order

00:32:28.916 --> 00:32:32.716 A:middle
of the preferred data sources
that exist in the Health App.

00:32:32.716 --> 00:32:35.576 A:middle
This way, our users get
a consistent experience

00:32:35.796 --> 00:32:38.346 A:middle
of the view of their health
data throughout our ecosystem.

00:32:38.476 --> 00:32:42.146 A:middle
Now, I want to talk
about migrating data.

00:32:42.716 --> 00:32:45.526 A:middle
Let's say that you've launched
a new Bluetooth thermometer

00:32:45.636 --> 00:32:47.566 A:middle
and app that writes
data into HealthKit.

00:32:48.396 --> 00:32:50.966 A:middle
Your application has been in
the App Store for a few days,

00:32:51.046 --> 00:32:52.746 A:middle
but your users discover
a problem.

00:32:53.516 --> 00:32:57.856 A:middle
In certain locales, instead of
saving 98 degrees Fahrenheit,

00:32:58.726 --> 00:33:01.386 A:middle
you actually save
98 degrees Celsius.

00:33:01.776 --> 00:33:03.136 A:middle
That's a bit warm.

00:33:04.186 --> 00:33:06.896 A:middle
But in this case, we know
exactly how we can migrate this

00:33:06.976 --> 00:33:08.496 A:middle
data in order to fix it.

00:33:08.946 --> 00:33:14.866 A:middle
We first need to find old
samples, write new samples,

00:33:14.916 --> 00:33:17.336 A:middle
making sure to update
UUID stored elsewhere,

00:33:17.336 --> 00:33:20.816 A:middle
and then delete old samples.

00:33:22.936 --> 00:33:25.746 A:middle
Now, a few new things
regarding the flow of data

00:33:25.746 --> 00:33:27.456 A:middle
between iPhone and Apple Watch.

00:33:28.986 --> 00:33:32.106 A:middle
Starting in iOS 9.3,
data originating

00:33:32.106 --> 00:33:34.246 A:middle
on a user's phone will
now sync back to all

00:33:34.246 --> 00:33:35.386 A:middle
of their paired Apple Watches.

00:33:35.646 --> 00:33:37.516 A:middle
Apple Watch is now a reflection

00:33:37.516 --> 00:33:39.436 A:middle
of the most recent
health data stored

00:33:39.436 --> 00:33:41.036 A:middle
within the HealthKit ecosystem.

00:33:41.166 --> 00:33:44.066 A:middle
In order to accomplish this,

00:33:44.446 --> 00:33:47.526 A:middle
samples are now periodically
pruned based off their end date

00:33:47.656 --> 00:33:49.306 A:middle
on Apple Watch.

00:33:52.576 --> 00:33:54.346 A:middle
Make sure to save samples

00:33:54.346 --> 00:33:58.316 A:middle
after HKHealthStore's earliest
permitted sample date in order

00:33:58.316 --> 00:34:00.266 A:middle
to make sure your samples
are correctly saved

00:34:00.756 --> 00:34:03.176 A:middle
and synced back to
a user's device.

00:34:05.076 --> 00:34:07.786 A:middle
Lastly, sync times
are not guaranteed.

00:34:09.056 --> 00:34:12.166 A:middle
You should be saving
data on either iPhone

00:34:12.166 --> 00:34:14.846 A:middle
or Apple Watch, not both.

00:34:17.476 --> 00:34:20.706 A:middle
Now, I'm going to hand it back
off to Matt, who's going to wrap

00:34:20.706 --> 00:34:21.846 A:middle
up the rest of our session.

00:34:22.276 --> 00:34:24.486 A:middle
Thank you, everyone,
and have a great WWDC.

00:34:25.516 --> 00:34:29.976 A:middle
[ Applause ]

00:34:30.476 --> 00:34:30.996 A:middle
&gt;&gt; Thank you, Jeff.

00:34:32.206 --> 00:34:35.656 A:middle
Before we wrap up, I'd like to
highlight one awesome additional

00:34:35.656 --> 00:34:38.806 A:middle
feature that's brand new
in iOS 10 and watchOS 3.

00:34:40.456 --> 00:34:41.686 A:middle
Wheelchair support.

00:34:43.526 --> 00:34:46.626 A:middle
Accessibility is extremely
important to use here at Apple.

00:34:47.276 --> 00:34:50.656 A:middle
All of our and your users
deserve to enjoy our products

00:34:50.656 --> 00:34:52.686 A:middle
and experiences as
much as possible,

00:34:53.196 --> 00:34:55.386 A:middle
and the great activity
tracking experience we brought

00:34:55.386 --> 00:34:57.136 A:middle
to Apple Watch is no exception.

00:34:58.536 --> 00:35:02.506 A:middle
iOS 10 and watchOS 3 include
great new motion-tracking

00:35:02.506 --> 00:35:05.346 A:middle
features that automatically
record data important

00:35:05.346 --> 00:35:06.216 A:middle
to wheelchair users.

00:35:06.836 --> 00:35:09.736 A:middle
And now you can work with
and contribute to those types

00:35:09.866 --> 00:35:11.366 A:middle
when you're interacting
with HealthKit.

00:35:11.836 --> 00:35:16.576 A:middle
First, there's a new
characteristic data type,

00:35:16.816 --> 00:35:19.876 A:middle
HKWheelchairUse that
identifies whether the user uses

00:35:19.876 --> 00:35:20.416 A:middle
a wheelchair.

00:35:20.906 --> 00:35:23.916 A:middle
The value can be yes,
no, or indeterminate.

00:35:24.386 --> 00:35:27.806 A:middle
Next, we have some new
quantity types specific

00:35:27.806 --> 00:35:28.696 A:middle
to wheelchair users.

00:35:28.866 --> 00:35:31.956 A:middle
Those include wheelchair
distance and push count,

00:35:31.956 --> 00:35:34.046 A:middle
which you can think
of like step count.

00:35:35.156 --> 00:35:37.896 A:middle
Finally, we have some new
workout types important

00:35:37.896 --> 00:35:39.176 A:middle
to wheelchair users as well.

00:35:39.446 --> 00:35:42.816 A:middle
Those include wheelchair walk
pace and wheelchair run pace.

00:35:46.876 --> 00:35:49.236 A:middle
When a wheelchair user
is using Apple Watch,

00:35:49.356 --> 00:35:51.836 A:middle
the watch automatically
records wheelchair pushes

00:35:51.836 --> 00:35:53.286 A:middle
to the new push count data type.

00:35:54.276 --> 00:35:57.066 A:middle
In addition, the stand
ring corresponding

00:35:57.066 --> 00:36:00.396 A:middle
to the stand hours data type
instead becomes roll hours.

00:36:01.706 --> 00:36:05.026 A:middle
Be aware that wheelchair
distance is only automatically

00:36:05.026 --> 00:36:08.876 A:middle
recorded during a wheelchair
workout and also be aware

00:36:09.166 --> 00:36:12.096 A:middle
that a user's wheelchair
status can change over time.

00:36:12.666 --> 00:36:13.746 A:middle
This is really important

00:36:13.746 --> 00:36:15.516 A:middle
if you're querying
for historical data.

00:36:15.926 --> 00:36:18.076 A:middle
In this case, you want to
make sure that you query

00:36:18.256 --> 00:36:21.386 A:middle
for both wheelchair types
and non-wheelchair types

00:36:21.386 --> 00:36:23.606 A:middle
so that you're not potentially
leaving out a big chunk

00:36:23.606 --> 00:36:25.836 A:middle
of the user's historical
information.

00:36:26.516 --> 00:36:30.346 A:middle
To sum up, we work really
hard to make sure that all

00:36:30.346 --> 00:36:33.126 A:middle
of our products and experiences
are accessible to everyone.

00:36:33.536 --> 00:36:34.516 A:middle
You should too.

00:36:34.826 --> 00:36:37.566 A:middle
We strongly encourage you to
reach this important segment

00:36:37.566 --> 00:36:40.176 A:middle
of our users by supporting
and contributing

00:36:40.176 --> 00:36:43.006 A:middle
to wheelchair data
types in your apps.

00:36:44.776 --> 00:36:48.266 A:middle
So we've talked about
a lot today.

00:36:48.586 --> 00:36:49.226 A:middle
Let's recap.

00:36:50.996 --> 00:36:53.276 A:middle
Authorization is
extremely important

00:36:53.276 --> 00:36:54.816 A:middle
for protecting users' privacy,

00:36:55.056 --> 00:36:58.136 A:middle
but getting the user experience
right is absolutely key.

00:36:59.276 --> 00:37:01.786 A:middle
Keep authorization in mind when
you're developing your app,

00:37:01.946 --> 00:37:03.446 A:middle
and be sure to test it often.

00:37:03.926 --> 00:37:08.326 A:middle
Next, fit in with Apple's
health and fitness ecosystem

00:37:08.426 --> 00:37:10.966 A:middle
by incorporating the Activity
Rings right into your app

00:37:11.136 --> 00:37:14.846 A:middle
with the Activity Rings API.

00:37:15.086 --> 00:37:16.706 A:middle
Whenever you're interacting
with HealthKit,

00:37:17.056 --> 00:37:20.066 A:middle
take care to handle all cases
where data is synchronized,

00:37:20.066 --> 00:37:22.836 A:middle
deleted, or duplicated
properly to ensure

00:37:22.836 --> 00:37:24.996 A:middle
that your users' data
is always precise

00:37:25.316 --> 00:37:28.406 A:middle
and always what you'd expect.

00:37:28.956 --> 00:37:31.796 A:middle
And finally, don't forget to
take advantage of the great,

00:37:31.796 --> 00:37:34.356 A:middle
new features we've
introduced this year in iOS 10

00:37:34.356 --> 00:37:37.376 A:middle
and watchOS 3, especially
wheelchair support,

00:37:37.636 --> 00:37:39.606 A:middle
something we think is
extremely important.

00:37:41.776 --> 00:37:44.646 A:middle
If you'd like more
information about any

00:37:44.646 --> 00:37:45.946 A:middle
of the things we
talked about today

00:37:45.946 --> 00:37:48.186 A:middle
or if you have any questions,
please visit this site.

00:37:48.186 --> 00:37:50.306 A:middle
We have lots of additional
resources available.

00:37:50.856 --> 00:37:55.196 A:middle
And don't forget to check out
our related sessions as well.

00:37:55.966 --> 00:37:58.306 A:middle
We also have these great
sessions from previous years

00:37:58.306 --> 00:37:59.976 A:middle
if you want to get up
to speed on HealthKit.

00:38:00.586 --> 00:38:02.276 A:middle
Thank you for creating
your great apps

00:38:02.276 --> 00:38:04.106 A:middle
that help users live
healthier lives

00:38:04.106 --> 00:38:06.546 A:middle
and enjoy the rest of your WWDC.

00:38:07.508 --> 00:38:09.508 A:middle
[ Applause ]