WEBVTT

00:00:00.506 --> 00:00:11.626 A:middle
[ Silence ]

00:00:12.126 --> 00:00:16.686 A:middle
&gt;&gt; Hello, good afternoon,
welcome to session 505,

00:00:16.756 --> 00:00:19.426 A:middle
"Harnessing Metadata
in Audiovisual Media".

00:00:20.026 --> 00:00:22.846 A:middle
I've heard we are competing
with the "Intro to Swift" talk

00:00:22.846 --> 00:00:24.956 A:middle
so get intimate with
your neighbors here.

00:00:25.626 --> 00:00:28.476 A:middle
My name is Adam Sonnanstine.

00:00:28.476 --> 00:00:30.916 A:middle
I'm an engineer on
the AVFoundation team

00:00:30.916 --> 00:00:33.586 A:middle
and today we are going to talk
about, of course, metadata.

00:00:34.296 --> 00:00:35.646 A:middle
So what do I mean by metadata?

00:00:35.996 --> 00:00:38.416 A:middle
Well, for the purposes
of this talk we're going

00:00:38.416 --> 00:00:40.896 A:middle
to define metadata to mean
any data that is stored

00:00:40.896 --> 00:00:44.296 A:middle
in movie files, streaming
presentations, any other sort

00:00:44.296 --> 00:00:49.636 A:middle
of audiovisual presentation
that describes the primary data,

00:00:49.636 --> 00:00:51.876 A:middle
like the audio and video that
we think about when we think

00:00:51.876 --> 00:00:53.146 A:middle
of those sorts of presentations.

00:00:53.856 --> 00:00:55.556 A:middle
Some examples are
always helpful.

00:00:56.336 --> 00:00:58.946 A:middle
One you should be familiar
is iTunes metadata,

00:00:59.376 --> 00:01:02.606 A:middle
when you have this sort of
the song names and the artists

00:01:02.606 --> 00:01:05.756 A:middle
and the album artwork
in your iTunes library.

00:01:05.986 --> 00:01:08.376 A:middle
All these things are stored
as the sort of metadata

00:01:08.376 --> 00:01:10.436 A:middle
that I'm talking about
today in the files

00:01:10.436 --> 00:01:11.506 A:middle
in your iTunes library.

00:01:12.756 --> 00:01:15.426 A:middle
Besides iTunes metadata,
we also have things

00:01:15.426 --> 00:01:16.836 A:middle
like location information.

00:01:17.166 --> 00:01:20.006 A:middle
If you have a movie that
you took with your iPhone

00:01:20.006 --> 00:01:23.226 A:middle
or some other location-enabled
device and you played it

00:01:23.226 --> 00:01:26.146 A:middle
in QuickTime player, that will
show up in the info window

00:01:26.216 --> 00:01:28.956 A:middle
to tell you where you were
when you took that movie.

00:01:29.356 --> 00:01:31.206 A:middle
That's also stored as
the kind of metadata

00:01:31.206 --> 00:01:33.816 A:middle
that we are talking about today.

00:01:33.816 --> 00:01:36.966 A:middle
Some new features, we know that
you're not always standing still

00:01:36.966 --> 00:01:38.006 A:middle
when you are taking your videos.

00:01:38.086 --> 00:01:43.006 A:middle
So new in iOS 8 and OS X
Yosemite, we have features

00:01:43.106 --> 00:01:46.456 A:middle
that support things like dynamic
location, that's a location

00:01:46.456 --> 00:01:47.666 A:middle
that changes over time.

00:01:47.666 --> 00:01:49.456 A:middle
So these are some new features
that we are going to be talking

00:01:49.456 --> 00:01:52.996 A:middle
about later on that we are
pretty excited about and,

00:01:53.406 --> 00:01:57.436 A:middle
in addition to location, this
really applies to any sort

00:01:57.436 --> 00:02:00.176 A:middle
of metadata that you might
want to add that changes

00:02:00.176 --> 00:02:01.636 A:middle
over time in your movie.

00:02:02.066 --> 00:02:04.536 A:middle
This is a screen shot of a
demo app we'll show you later

00:02:04.856 --> 00:02:07.786 A:middle
but the circle and the
annotation text that's all

00:02:07.786 --> 00:02:12.456 A:middle
stored as the same sort of timed
metadata as a timed location.

00:02:13.136 --> 00:02:14.846 A:middle
So hopefully that whets
your appetite a little bit.

00:02:15.206 --> 00:02:17.526 A:middle
We'll talk about what
we're going to cover today,

00:02:17.526 --> 00:02:19.716 A:middle
we're going to start, I'm going
to give you an intro to metadata

00:02:19.716 --> 00:02:21.986 A:middle
and AVFoundation, some of
the classes that have been

00:02:21.986 --> 00:02:25.006 A:middle
around for a while for
describing all sorts

00:02:25.006 --> 00:02:27.776 A:middle
of metadata, how to inspect
that and how to author it.

00:02:27.776 --> 00:02:29.126 A:middle
We're going to talk more

00:02:29.126 --> 00:02:30.966 A:middle
about those new timed
metadata features

00:02:31.046 --> 00:02:35.256 A:middle
and then I'll give you some best
practices including some privacy

00:02:35.256 --> 00:02:37.856 A:middle
things to keep in mind and
some other best practices.

00:02:38.856 --> 00:02:42.006 A:middle
So our first topic: metadata
in AVFoundation..What kind

00:02:42.006 --> 00:02:44.906 A:middle
of classes are we going to be
using to describe our metadata?

00:02:45.346 --> 00:02:48.316 A:middle
Well our primary model
objects that we use

00:02:48.376 --> 00:02:54.536 A:middle
to describe both movie files
or HLS streams is AVAsset.

00:02:54.986 --> 00:03:00.036 A:middle
AVAsset can contain any
number of AV metadata objects

00:03:00.376 --> 00:03:05.646 A:middle
and each AVMetadataItem instance
represents a single piece

00:03:05.646 --> 00:03:08.686 A:middle
of metadata, either your
track name or your album mark,

00:03:08.976 --> 00:03:13.316 A:middle
even your location stuff that's
going to be separate pieces

00:03:13.316 --> 00:03:15.836 A:middle
of metadata in our
runtime environment.

00:03:16.196 --> 00:03:19.946 A:middle
So a closer look at
AVMetadataItem: at its core,

00:03:20.196 --> 00:03:21.436 A:middle
it has two properties.

00:03:22.076 --> 00:03:24.536 A:middle
The first is identifier, which
is actually a new property

00:03:24.906 --> 00:03:26.636 A:middle
and that is going
to describe the kind

00:03:26.636 --> 00:03:27.676 A:middle
of metadata that you have.

00:03:27.866 --> 00:03:31.626 A:middle
In this example we have the
song name and it's represented

00:03:31.626 --> 00:03:33.036 A:middle
by this long symbol name,

00:03:33.036 --> 00:03:36.396 A:middle
AVMetadataIdentifieriTunes
MetadataSongName,

00:03:37.026 --> 00:03:38.276 A:middle
and then you have the value

00:03:38.276 --> 00:03:40.436 A:middle
which is the actual payload
of the metadata item.

00:03:40.436 --> 00:03:43.136 A:middle
So for song name, it's the
name of the song as a string.

00:03:44.896 --> 00:03:47.446 A:middle
As an example for cover art,

00:03:47.446 --> 00:03:49.706 A:middle
you can see that the
value doesn't have

00:03:49.706 --> 00:03:53.256 A:middle
to be a string it can be an
image or any other object

00:03:53.506 --> 00:03:57.576 A:middle
that supports both the NSObject
and NSCopying protocols.

00:03:58.456 --> 00:04:00.696 A:middle
Now if you've used
AVMetadataItem

00:04:00.696 --> 00:04:03.356 A:middle
in the past you might
be familiar with the key

00:04:03.356 --> 00:04:04.646 A:middle
and key space properties.

00:04:05.196 --> 00:04:07.266 A:middle
Well the identifier I
mentioned that was new,

00:04:07.616 --> 00:04:09.306 A:middle
it's new because
it is a combination

00:04:09.306 --> 00:04:11.626 A:middle
of the old properties,
key and key space.

00:04:11.626 --> 00:04:14.216 A:middle
So I'm not going to talking much
about key and key space today

00:04:14.216 --> 00:04:17.066 A:middle
but mostly going to be talking
about identifier going forward

00:04:17.066 --> 00:04:19.376 A:middle
as the way to describe
your metadata.

00:04:20.446 --> 00:04:22.846 A:middle
Take a look at some of the
built-in identifiers we have;

00:04:23.346 --> 00:04:24.736 A:middle
this is just a tiny sampling.

00:04:24.736 --> 00:04:25.626 A:middle
There's a lot of them.

00:04:25.626 --> 00:04:26.376 A:middle
You can find them

00:04:26.376 --> 00:04:29.856 A:middle
in AVMetadataIdentifiers.h. I've
arranged them here according

00:04:29.856 --> 00:04:34.476 A:middle
roughly to the old notion of
key space so that's just sort

00:04:34.476 --> 00:04:37.526 A:middle
of a sampling of the kind of
metadata that we already know

00:04:37.526 --> 00:04:38.866 A:middle
that you might want
to represent.

00:04:40.196 --> 00:04:42.846 A:middle
Going back to the
metadata item itself,

00:04:43.926 --> 00:04:47.826 A:middle
we have a property that's
also new called dataType,

00:04:47.826 --> 00:04:49.686 A:middle
which describes the
native data type

00:04:50.026 --> 00:04:51.886 A:middle
that your metadata
is representing.

00:04:52.236 --> 00:04:54.956 A:middle
So for the case of our song
name it's stored as a string

00:04:54.956 --> 00:04:57.486 A:middle
so we see that the data
type is a UTF8 string;

00:04:57.926 --> 00:04:59.526 A:middle
and these string constants

00:04:59.526 --> 00:05:02.336 A:middle
that represent the different
data types are all defined

00:05:02.336 --> 00:05:07.956 A:middle
in CMMetadata.h. And besides
the data type property,

00:05:07.956 --> 00:05:11.356 A:middle
we also have several
type coercion properties

00:05:11.356 --> 00:05:14.106 A:middle
that you can use if you know
you want to get your payload

00:05:14.346 --> 00:05:17.536 A:middle
in the form of a certain
type of Objective C object.

00:05:17.536 --> 00:05:21.286 A:middle
So you have string value, number
value, date value and data value

00:05:21.566 --> 00:05:24.656 A:middle
and those are going to give
you exactly what you'd expect.

00:05:24.976 --> 00:05:28.726 A:middle
For the case of where our
native payload is a string,

00:05:28.946 --> 00:05:31.526 A:middle
only string value is going to
give you an interesting answer.

00:05:31.526 --> 00:05:32.596 A:middle
The rest will give you NULL.

00:05:33.226 --> 00:05:36.476 A:middle
For our artwork example where
the payload is a JPEG image,

00:05:36.976 --> 00:05:39.236 A:middle
the top three are
going to give you NULL

00:05:39.496 --> 00:05:42.286 A:middle
and the data value is going
to give you the NSData

00:05:42.286 --> 00:05:45.646 A:middle
that you're looking for to grab
the bytes of the JPEG image.

00:05:46.506 --> 00:05:48.796 A:middle
There are examples
where you can have more

00:05:48.796 --> 00:05:52.466 A:middle
than one non-nil
tech coercion method.

00:05:52.756 --> 00:05:56.986 A:middle
And one is creation date if
you have the date represented

00:05:56.986 --> 00:05:59.236 A:middle
as a standard string
format for dates.

00:05:59.666 --> 00:06:05.126 A:middle
You can either get the actual
string that was stored that way

00:06:05.376 --> 00:06:08.286 A:middle
or you can ask the metadata
item to give you an instance

00:06:08.286 --> 00:06:10.266 A:middle
of NSDate that describes
the same thing

00:06:10.266 --> 00:06:12.326 A:middle
in a more convenient
representation.

00:06:12.636 --> 00:06:15.536 A:middle
So that's your brief
intro to AVMetadataItem,

00:06:15.536 --> 00:06:17.636 A:middle
we're going to be talking a lot
about it throughout the talk.

00:06:17.906 --> 00:06:19.356 A:middle
Let's go back to AVAsset

00:06:19.356 --> 00:06:21.866 A:middle
so we can see how we actually
get these metadata items.

00:06:21.866 --> 00:06:25.606 A:middle
So the easiest way is just to
ask for all of the metadata

00:06:25.606 --> 00:06:27.286 A:middle
that applies to the
entire asset.

00:06:27.626 --> 00:06:30.456 A:middle
There are types of metadata that
apply to just parts of the asset

00:06:30.706 --> 00:06:33.686 A:middle
but this is how you get the
metadata to, like, the location

00:06:33.686 --> 00:06:35.796 A:middle
and the song title that
applies to the entire asset.

00:06:36.686 --> 00:06:40.036 A:middle
There's also a way to get
just a subset of the metadata.

00:06:40.586 --> 00:06:42.926 A:middle
We have this notion of metadata
format but I'm not going

00:06:42.926 --> 00:06:45.496 A:middle
to be talking about too much
today but you can use it

00:06:45.496 --> 00:06:47.656 A:middle
to get just that
subset of the metadata.

00:06:48.046 --> 00:06:50.656 A:middle
So for our example, when we
are getting iTunes metadata,

00:06:50.946 --> 00:06:54.426 A:middle
we're going to use that
AVMetadataFormatiTunesMetadata

00:06:54.426 --> 00:06:58.526 A:middle
and grab all of that using
the metadataForFormat method.

00:06:58.976 --> 00:07:02.146 A:middle
And then from there we can
use this filtering method,

00:07:02.146 --> 00:07:04.646 A:middle
metadataItemsFromArray,
filtered by an identifier

00:07:04.646 --> 00:07:07.346 A:middle
to get just the items
that correspond

00:07:07.346 --> 00:07:08.716 A:middle
to the song name identifier.

00:07:09.166 --> 00:07:11.026 A:middle
You might be wondering
why you can have more

00:07:11.026 --> 00:07:13.106 A:middle
than one song name
in a single asset?

00:07:13.336 --> 00:07:15.876 A:middle
We'll get back to that in just
a little bit but first I want

00:07:15.876 --> 00:07:19.986 A:middle
to talk about how you load the
payload of your metadata items.

00:07:20.336 --> 00:07:23.196 A:middle
AVMetadataItem conforms

00:07:23.196 --> 00:07:25.216 A:middle
to the
AVAsynchronousKeyValueLoading.h

00:07:25.216 --> 00:07:25.726 A:middle
protocol.

00:07:25.726 --> 00:07:28.706 A:middle
This is a protocol we define
ourselves in AVFoundation

00:07:28.776 --> 00:07:32.076 A:middle
and a lot of our core
model objects conform to it

00:07:32.546 --> 00:07:35.686 A:middle
because a lot of times
when you get an AVAsset

00:07:35.686 --> 00:07:38.686 A:middle
or an AVMetadataItem we haven't
actually loaded the data behind

00:07:38.686 --> 00:07:39.006 A:middle
it yet.

00:07:39.006 --> 00:07:43.326 A:middle
So you can use this method, load
values asynchronously for keys

00:07:43.826 --> 00:07:46.326 A:middle
to load the specific values
you want and they'll do

00:07:46.326 --> 00:07:48.926 A:middle
that asynchronously so you're
not blocking your main thread

00:07:49.206 --> 00:07:51.876 A:middle
with some sort of synchronous
I/O or something like that.

00:07:52.426 --> 00:07:54.436 A:middle
So for this case we
have our metadata item.

00:07:54.796 --> 00:07:58.216 A:middle
We're looking for the value so
we just load the key value and,

00:07:58.216 --> 00:07:59.516 A:middle
when we get our completion
handler,

00:07:59.856 --> 00:08:01.556 A:middle
we're going to check
the status to make sure

00:08:01.556 --> 00:08:04.256 A:middle
that that loading succeeded
and, assuming that we did,

00:08:04.386 --> 00:08:06.386 A:middle
we can then just go
ahead and grab the value

00:08:06.386 --> 00:08:07.856 A:middle
and use it however we see fit.

00:08:08.556 --> 00:08:12.836 A:middle
So back to that whole multiple
titles in one asset string.

00:08:12.836 --> 00:08:16.396 A:middle
Well, one reason we
might have that is

00:08:16.446 --> 00:08:20.016 A:middle
if we have the asset localized
in multiple languages.

00:08:20.016 --> 00:08:22.836 A:middle
So an asset can have
the same metadata items

00:08:22.836 --> 00:08:23.976 A:middle
in multiple languages.

00:08:24.426 --> 00:08:25.836 A:middle
The example that
we're going to talk

00:08:25.836 --> 00:08:28.466 A:middle
about is
QuickTimeUserDataFullName

00:08:28.776 --> 00:08:29.696 A:middle
dat identifier.

00:08:29.936 --> 00:08:32.136 A:middle
If you use this identifier
in your files,

00:08:32.416 --> 00:08:35.396 A:middle
then QuickTime Player, for
example, can pick up the title

00:08:35.566 --> 00:08:36.886 A:middle
and display it in the title bar.

00:08:36.886 --> 00:08:39.206 A:middle
So this is just yet
another example

00:08:39.206 --> 00:08:41.996 A:middle
of how metadata is used
in our applications.

00:08:42.526 --> 00:08:44.576 A:middle
This particular example

00:08:44.576 --> 00:08:49.176 A:middle
of the movie actually has the
title available in both English

00:08:49.176 --> 00:08:53.456 A:middle
and Spanish so here we have the
English as the system language

00:08:53.456 --> 00:08:56.486 A:middle
so QuickTime Player picks that
up, picks up the English title

00:08:56.486 --> 00:08:59.816 A:middle
but if we set our system
language to Spanish it will pick

00:08:59.816 --> 00:09:02.286 A:middle
up the Spanish localization
of that title instead.

00:09:02.746 --> 00:09:06.986 A:middle
These are represented as two
distinct pieces of metadata

00:09:06.986 --> 00:09:10.456 A:middle
within the file and the way that
you distinguish between them is

00:09:10.456 --> 00:09:11.696 A:middle
that they'll have
different values

00:09:11.696 --> 00:09:15.056 A:middle
for these final two properties
of AVMetadataItem locale

00:09:15.116 --> 00:09:16.406 A:middle
and extendedLanguageTag.

00:09:17.106 --> 00:09:19.586 A:middle
ExtendedLanguageTag is
new in this release.

00:09:19.716 --> 00:09:23.166 A:middle
It's a BCP 47 language tag
and it's particularly useful

00:09:23.166 --> 00:09:24.856 A:middle
when you want to
distinguish written languages.

00:09:25.616 --> 00:09:29.596 A:middle
So that's one reason
why you might have more

00:09:29.596 --> 00:09:32.326 A:middle
than one metadata item
with the same identifier.

00:09:32.326 --> 00:09:36.916 A:middle
So I mentioned before that
not all metadata applies

00:09:37.036 --> 00:09:40.726 A:middle
to the entire asset, well one
example of that is metadata

00:09:40.726 --> 00:09:42.566 A:middle
that only applies to
a particular track,

00:09:42.636 --> 00:09:45.976 A:middle
so for this example we have
a special label attached

00:09:45.976 --> 00:09:49.506 A:middle
to our subtitle track called
SDH, that stands for Subtitles

00:09:49.506 --> 00:09:51.336 A:middle
for the Deaf or Hard of Hearing

00:09:51.866 --> 00:09:56.616 A:middle
and that's basically just a
more rich form of subtitles

00:09:57.196 --> 00:09:59.956 A:middle
that includes things like
labeling who's talking

00:10:00.176 --> 00:10:01.956 A:middle
and mentioning sound effects

00:10:01.956 --> 00:10:04.056 A:middle
that are vital to
the understanding.

00:10:04.056 --> 00:10:09.416 A:middle
We talked a little bit more
about SDH and accessibility

00:10:09.416 --> 00:10:11.956 A:middle
in general last year in our
"Preparing and Presenting Media

00:10:11.956 --> 00:10:14.766 A:middle
for Accessibility" talk so check
that one out for more details.

00:10:14.766 --> 00:10:16.076 A:middle
For the purposes of this talk,

00:10:16.416 --> 00:10:18.886 A:middle
just know that to get
this SDH label here,

00:10:19.106 --> 00:10:21.446 A:middle
it involves setting
track-specific metadata.

00:10:21.936 --> 00:10:23.816 A:middle
So let's talk about
how you actually find

00:10:23.816 --> 00:10:25.806 A:middle
out if your track has
this metadata in it,

00:10:26.356 --> 00:10:29.166 A:middle
well you're going
to use AVAsset track

00:10:29.466 --> 00:10:31.586 A:middle
and it has pretty much
the exact same API

00:10:31.586 --> 00:10:32.976 A:middle
as AVAsset for reading metadata.

00:10:33.196 --> 00:10:35.486 A:middle
You have your metadata property;

00:10:35.896 --> 00:10:39.736 A:middle
you have your metadataForFormat
method and so if we want

00:10:39.736 --> 00:10:42.676 A:middle
to find all the tagged
characteristics that are

00:10:42.676 --> 00:10:46.526 A:middle
in an asset track, we're
going to ask the track

00:10:46.526 --> 00:10:49.186 A:middle
for its metadata for the
FormatQuickTimeUserData.

00:10:49.866 --> 00:10:50.996 A:middle
Once we have that we use

00:10:51.036 --> 00:10:54.556 A:middle
that same filtering method we
saw before in order to get all

00:10:54.556 --> 00:10:58.506 A:middle
of the items that
have the identifier,

00:10:58.506 --> 00:11:00.806 A:middle
QuickTimeUserDataTagged
Characteristic.

00:11:00.916 --> 00:11:05.136 A:middle
So this is one example of tagged
characteristics is the SDH

00:11:05.256 --> 00:11:07.726 A:middle
that I just talked about
and it's the payload

00:11:07.726 --> 00:11:09.986 A:middle
of the metadata items
that tells you what kind

00:11:09.986 --> 00:11:12.316 A:middle
of tagged characteristic
you're dealing with.

00:11:12.716 --> 00:11:14.726 A:middle
We'll talk a little bit
more detail about SDH

00:11:14.726 --> 00:11:18.156 A:middle
and how you author it
in just a little bit.

00:11:18.586 --> 00:11:20.326 A:middle
So going back to our list

00:11:20.326 --> 00:11:23.506 A:middle
of identifiers you might
have noticed some patterns

00:11:23.506 --> 00:11:24.636 A:middle
if you were looking closely.

00:11:25.856 --> 00:11:29.796 A:middle
Each of these groups has
their own version of a title

00:11:29.796 --> 00:11:31.496 A:middle
or a song name or
something like that.

00:11:32.116 --> 00:11:36.036 A:middle
We noticed that and come up
with our own special kind

00:11:36.036 --> 00:11:38.226 A:middle
of identifier called
a CommonIdentifier

00:11:38.776 --> 00:11:41.296 A:middle
which can be used when
you want to look up, say,

00:11:41.296 --> 00:11:45.236 A:middle
for this example a title without
caring exactly how it's stored

00:11:45.236 --> 00:11:45.966 A:middle
in your file.

00:11:46.616 --> 00:11:49.946 A:middle
Same for copyright here; we
also have a common identifier

00:11:49.946 --> 00:11:51.116 A:middle
that represents copyright.

00:11:51.756 --> 00:11:53.566 A:middle
These are not the only
common identifiers;

00:11:53.646 --> 00:11:56.766 A:middle
there's a whole list of them
but these are just two examples.

00:11:57.256 --> 00:11:59.366 A:middle
So if we go back to our
example where we're looking

00:11:59.366 --> 00:12:02.526 A:middle
for our iTunes song name,
if we don't actually care

00:12:02.526 --> 00:12:06.496 A:middle
that the title of our asset
is stored as iTunes metadata

00:12:06.496 --> 00:12:09.356 A:middle
and we just want a title so
we can display it somewhere,

00:12:09.646 --> 00:12:12.606 A:middle
you can ask the asset for
its array of commonMetadata

00:12:12.606 --> 00:12:14.216 A:middle
and this is all the
metadata items

00:12:14.536 --> 00:12:18.816 A:middle
that can be represented
using a common identifier.

00:12:19.296 --> 00:12:22.176 A:middle
Then you use that same filtering
method we've been using

00:12:22.176 --> 00:12:23.956 A:middle
to filter down to just the ones

00:12:23.956 --> 00:12:25.696 A:middle
that have the
CommonIdentifierTitle

00:12:26.076 --> 00:12:28.996 A:middle
and you can go from
there with your title.

00:12:28.996 --> 00:12:30.216 A:middle
Also worth noting is

00:12:30.276 --> 00:12:34.976 A:middle
that AVAssetTrack has the
same property, commonMetadata,

00:12:34.976 --> 00:12:36.886 A:middle
so you can do the same
thing over there as well.

00:12:37.426 --> 00:12:40.856 A:middle
So that is your brief
introduction

00:12:40.856 --> 00:12:43.076 A:middle
to inspecting metadata
with AVFoundation.

00:12:43.316 --> 00:12:45.186 A:middle
Let's talk a little
bit about authoring.

00:12:45.186 --> 00:12:48.096 A:middle
If you want to make your own
files that have say location

00:12:48.096 --> 00:12:52.156 A:middle
or iTunes metadata in them, we
have several different classes

00:12:52.156 --> 00:12:55.766 A:middle
that can write movie
files, AVAssetExportSession,

00:12:55.766 --> 00:12:59.396 A:middle
AVAssetWriter and the capture
movie and audio files outputs

00:12:59.446 --> 00:13:02.576 A:middle
and these all have the exact
same redirect property called

00:13:02.576 --> 00:13:03.426 A:middle
simply, metadata.

00:13:03.426 --> 00:13:06.126 A:middle
So you give an array of
metadata items and then

00:13:06.126 --> 00:13:07.706 A:middle
that will be written
out to the file.

00:13:08.476 --> 00:13:11.246 A:middle
Similarly for track-specific
metadata

00:13:11.246 --> 00:13:12.806 A:middle
like those tagged
characteristics,

00:13:13.186 --> 00:13:15.426 A:middle
you can use an AVAssetWriter
input

00:13:15.656 --> 00:13:18.176 A:middle
which also has the
exact same property.

00:13:19.166 --> 00:13:23.696 A:middle
Now you are not limited to
just writing out metadata

00:13:23.696 --> 00:13:25.636 A:middle
that you got from somewhere
else, like another file

00:13:25.636 --> 00:13:27.146 A:middle
through the APIs
we've been looking at.

00:13:27.386 --> 00:13:29.336 A:middle
You can also create
your own metadata items

00:13:29.336 --> 00:13:32.006 A:middle
with a mutable subclass
of metadataItem.

00:13:32.356 --> 00:13:34.996 A:middle
And as you might expect, this
just has read/write properties

00:13:34.996 --> 00:13:38.536 A:middle
for all of the properties
in AVMetadataItem.

00:13:39.056 --> 00:13:42.546 A:middle
So if we use an example of
writing a subtitle track

00:13:42.546 --> 00:13:46.666 A:middle
that is marked as SDH, well
it's actually two different tag

00:13:46.666 --> 00:13:48.266 A:middle
characteristics that
you have to use

00:13:48.376 --> 00:13:50.566 A:middle
and so we'll create two
different metadata items,

00:13:50.936 --> 00:13:55.556 A:middle
set both of their identifiers
to the identifier we just saw,

00:13:55.776 --> 00:13:58.106 A:middle
the QuickTimeUserData
tag characteristic,

00:13:58.616 --> 00:14:00.206 A:middle
but one of them will
set the value

00:14:00.206 --> 00:14:02.816 A:middle
to TranscribesSpokenDialogue
ForAccessibility

00:14:02.816 --> 00:14:05.116 A:middle
and the other will be
DescribesMusicAndSound

00:14:05.116 --> 00:14:06.066 A:middle
ForAccessibility.

00:14:06.476 --> 00:14:09.556 A:middle
Then we get the subtitle
AssetWriterInputthat's going

00:14:09.556 --> 00:14:13.486 A:middle
to write our subtitle track and
set that array of the two items

00:14:13.486 --> 00:14:15.126 A:middle
on our asset writer input.

00:14:15.336 --> 00:14:18.486 A:middle
So that's how you would
author a subtitle track

00:14:18.596 --> 00:14:20.516 A:middle
that is marked as SDH.

00:14:20.516 --> 00:14:23.506 A:middle
Just one example of
using tag characteristics

00:14:23.776 --> 00:14:25.316 A:middle
in AVMutableMetadataItem.

00:14:26.116 --> 00:14:29.646 A:middle
Special note about
AVAssetExportSession:

00:14:30.776 --> 00:14:33.896 A:middle
by default the ExportSession
is actually going to take any

00:14:33.896 --> 00:14:37.006 A:middle
of the metadata that's
in the source asset

00:14:37.006 --> 00:14:37.976 A:middle
that you're exporting.

00:14:38.236 --> 00:14:40.696 A:middle
It's going to copy that
over to the output file.

00:14:41.326 --> 00:14:43.656 A:middle
Now that's not the case
if you set metadata

00:14:43.656 --> 00:14:44.906 A:middle
on its metadata property.

00:14:45.396 --> 00:14:47.386 A:middle
That will be the signal
to tell the ExportSession

00:14:47.386 --> 00:14:49.516 A:middle
to ignore the metadata
in the source file

00:14:49.726 --> 00:14:52.506 A:middle
and instead write just what
you put on the property.

00:14:52.956 --> 00:14:55.836 A:middle
So if you want to do
augmentation of the metadata

00:14:55.836 --> 00:14:59.146 A:middle
or some other sort of
modification you'll want to grab

00:14:59.146 --> 00:15:01.926 A:middle
that array of metadata,
make a mutable copy

00:15:01.926 --> 00:15:04.216 A:middle
and do any adjustments
that you want and then set

00:15:04.216 --> 00:15:05.956 A:middle
that on the metadata property.

00:15:06.046 --> 00:15:08.316 A:middle
So that's just a quick
note about ExportSession.

00:15:08.676 --> 00:15:12.536 A:middle
The last note about authoring
metadata is HTTP Live Streaming,

00:15:12.536 --> 00:15:16.006 A:middle
this is actually a new
feature in iOS 8, OS X Yosemite

00:15:16.086 --> 00:15:20.496 A:middle
and you can use a new tag
called session-data tag

00:15:20.496 --> 00:15:23.396 A:middle
in your playlist, which
has two required fields:

00:15:23.426 --> 00:15:26.226 A:middle
the data ID which is a
lot like our identifiers

00:15:26.226 --> 00:15:29.926 A:middle
that we're talking about, a URI
which can point to the payload

00:15:29.926 --> 00:15:33.376 A:middle
or a value which directly
specifies the payload and,

00:15:33.536 --> 00:15:35.276 A:middle
optionally, some
language information.

00:15:35.276 --> 00:15:37.316 A:middle
So here's an example
that shows very similar

00:15:37.316 --> 00:15:38.986 A:middle
to what we saw before
with the titles

00:15:38.986 --> 00:15:42.316 A:middle
in two different languages but
this is the markup you'd use

00:15:42.316 --> 00:15:44.356 A:middle
for HTTP Live Streaming.

00:15:44.896 --> 00:15:47.586 A:middle
So for more information
on reading

00:15:47.586 --> 00:15:49.896 A:middle
and writing metadata we
do have some sample code,

00:15:50.106 --> 00:15:53.806 A:middle
it's called AVmetadataeditor
and for more information

00:15:53.806 --> 00:15:58.416 A:middle
about the details of writing
HTTP Live Streaming metadata see

00:15:58.416 --> 00:16:00.326 A:middle
the documents at this URL.

00:16:00.436 --> 00:16:03.466 A:middle
All right so that is your
crash course in metadata

00:16:03.466 --> 00:16:07.206 A:middle
in AVFoundation, our next
topic is timed metadata.

00:16:08.046 --> 00:16:10.716 A:middle
So timed metadata, although I
mentioned we have new features,

00:16:10.716 --> 00:16:11.946 A:middle
it is not a new concept.

00:16:12.806 --> 00:16:15.426 A:middle
We supported the notion of
chapters for quite some time

00:16:15.716 --> 00:16:18.166 A:middle
and conceptually chapters
are just an example

00:16:18.166 --> 00:16:19.096 A:middle
of times metadata.

00:16:19.436 --> 00:16:22.616 A:middle
Each of these chapter markers
is just a piece of metadata

00:16:22.896 --> 00:16:26.446 A:middle
that is describing
a particular range

00:16:26.446 --> 00:16:27.836 A:middle
of the timeline of the movie.

00:16:28.496 --> 00:16:31.096 A:middle
That's all that timed
metadata is,

00:16:31.146 --> 00:16:34.336 A:middle
it's just metadata associated
with a range of time.

00:16:34.886 --> 00:16:40.076 A:middle
So similarly, with our
dynamic location example,

00:16:40.586 --> 00:16:43.336 A:middle
we have the path that's drawn
here that's really just composed

00:16:43.336 --> 00:16:45.216 A:middle
of a number of pieces

00:16:45.216 --> 00:16:48.106 A:middle
of metadata indicating
the current location,

00:16:48.306 --> 00:16:50.766 A:middle
each one of them associated
with a particular time

00:16:50.956 --> 00:16:52.036 A:middle
in the movie's timeline.

00:16:52.036 --> 00:16:55.496 A:middle
So to demonstrate
QuickTime Player's features

00:16:55.496 --> 00:16:57.896 A:middle
with dynamic location
in Yosemite,

00:16:57.896 --> 00:16:59.456 A:middle
I want to bring my
colleague, Shalini,

00:16:59.456 --> 00:17:00.606 A:middle
up to the stage for a demo.

00:17:01.566 --> 00:17:04.226 A:middle
&gt;&gt; Hi, I'm here to
demonstrate how to read

00:17:04.266 --> 00:17:06.726 A:middle
and play back metadata
using QuickTime Player.

00:17:07.876 --> 00:17:11.406 A:middle
Here I have a movie file
which has both audio and video

00:17:11.666 --> 00:17:14.906 A:middle
and timed locations data
stored in a different track.

00:17:15.686 --> 00:17:17.996 A:middle
So now if I bring this
up in QuickTime Player,

00:17:19.146 --> 00:17:21.456 A:middle
this is the usual UI
for audio and video.

00:17:22.206 --> 00:17:23.896 A:middle
New in OS X Yosemite:

00:17:24.286 --> 00:17:28.166 A:middle
in the Movie Inspector
you can see a map view

00:17:28.906 --> 00:17:30.746 A:middle
if your movie file
has location data.

00:17:31.226 --> 00:17:33.966 A:middle
Your map view is presented
along with the route

00:17:34.566 --> 00:17:35.996 A:middle
where you have recorded
this video.

00:17:37.186 --> 00:17:39.716 A:middle
So here the blue line
indicates the path

00:17:39.716 --> 00:17:43.496 A:middle
where we recorded the video and
the red pin is an indication

00:17:43.556 --> 00:17:45.736 A:middle
of the current location
or the location

00:17:46.166 --> 00:17:50.076 A:middle
on the timeline of the movie.

00:17:50.076 --> 00:17:52.556 A:middle
So if I zoom in a little
bit and start play,

00:17:52.906 --> 00:17:57.996 A:middle
you can see as the movie
progresses the pin's location is

00:17:57.996 --> 00:18:00.976 A:middle
being updated to be in
sync with the video.

00:18:01.576 --> 00:18:05.456 A:middle
I can drag the scrubber around

00:18:06.076 --> 00:18:08.116 A:middle
and you can see the pin
moving back and forth.

00:18:09.466 --> 00:18:15.296 A:middle
I can also go and click
at any point in the map

00:18:15.296 --> 00:18:18.376 A:middle
and you see the video seek
to that location to present

00:18:18.436 --> 00:18:21.576 A:middle
where your video was when
you were at that location.

00:18:22.876 --> 00:18:26.966 A:middle
This is map view in QuickTime
Player on OS X Yosemite.

00:18:27.866 --> 00:18:28.516 A:middle
&gt;&gt; Thank you, Shalini.

00:18:29.266 --> 00:18:31.386 A:middle
So let's talk about
what we just saw there.

00:18:32.256 --> 00:18:35.676 A:middle
So that location information
was stored as timed metadata

00:18:35.676 --> 00:18:38.866 A:middle
in the file and in order to
have QuickTime Player draw

00:18:38.866 --> 00:18:43.436 A:middle
that information on the map, we
use AVAssetReader to read all

00:18:43.436 --> 00:18:46.906 A:middle
of the location information
from that asset.

00:18:46.906 --> 00:18:50.436 A:middle
And because timed metadata
is stored in its own track,

00:18:50.746 --> 00:18:53.436 A:middle
we use an
AVAssetReaderTrackOutput to read

00:18:53.436 --> 00:18:56.836 A:middle
that data and we use a new
class called AVAssetReaderOutput

00:18:56.836 --> 00:19:00.066 A:middle
MetadataAdaptor that knows how
to give us that data in the

00:19:00.066 --> 00:19:02.946 A:middle
from of a class called
AVTimedMetadataGroup.

00:19:03.356 --> 00:19:05.636 A:middle
Then from there we
can grab each location

00:19:05.636 --> 00:19:07.066 A:middle
and draw that path on the map.

00:19:08.116 --> 00:19:11.376 A:middle
So AVTimedMetadataGroup
is a very simple class.

00:19:11.746 --> 00:19:13.476 A:middle
It's really just
these two properties:

00:19:13.476 --> 00:19:16.806 A:middle
an array of metadata items
combined with a time range

00:19:16.806 --> 00:19:20.106 A:middle
that describes where in the
movie that data applies.

00:19:20.646 --> 00:19:25.006 A:middle
So to see a little bit of
code for using AssetReader

00:19:25.006 --> 00:19:27.016 A:middle
for this purpose, the
first thing you want

00:19:27.016 --> 00:19:28.186 A:middle
to do is find the track

00:19:28.386 --> 00:19:31.616 A:middle
that contains your location
information and we'll talk more

00:19:31.616 --> 00:19:33.286 A:middle
about how to do that
in just a second.

00:19:33.676 --> 00:19:37.586 A:middle
Then you use that track to
create an AssetReaderTrackOutput

00:19:38.156 --> 00:19:39.736 A:middle
and you use nil output settings

00:19:40.276 --> 00:19:42.796 A:middle
and then you'll create
your metadataAdaptor

00:19:42.796 --> 00:19:43.916 A:middle
with that trackOutput.

00:19:44.626 --> 00:19:47.756 A:middle
And then, in a loop we just
take your metadataAdaptor

00:19:47.756 --> 00:19:50.866 A:middle
and call the
nextTimedMetadataGroup method

00:19:51.156 --> 00:19:53.606 A:middle
over and over again, doing
something with each piece

00:19:53.606 --> 00:19:55.496 A:middle
of data, like drawing
it on the map

00:19:55.666 --> 00:19:57.446 A:middle
until that method returns nil.

00:19:57.446 --> 00:19:58.946 A:middle
Then you know there's
no more data to draw.

00:19:58.946 --> 00:20:02.656 A:middle
So in terms of finding
the right track to read,

00:20:03.096 --> 00:20:05.616 A:middle
the way you're going to do
that is by examining the tracks

00:20:05.616 --> 00:20:08.276 A:middle
in your asset and looking
through the format description

00:20:08.276 --> 00:20:10.796 A:middle
of each track to find the
identifiers you're looking for.

00:20:10.876 --> 00:20:13.626 A:middle
So you first start
by getting the tracks

00:20:13.626 --> 00:20:15.826 A:middle
with the MediaTypeMetadata
and then for each

00:20:15.826 --> 00:20:17.806 A:middle
of those tracks you're
going to loop through all

00:20:17.806 --> 00:20:20.986 A:middle
of its format descriptions,
usually there's only one

00:20:21.316 --> 00:20:24.016 A:middle
and for each format description
you're going to grab its list

00:20:24.016 --> 00:20:26.916 A:middle
of identifiers using this
function and check whether

00:20:26.916 --> 00:20:28.596 A:middle
that identifier array
contains the identifier you're

00:20:28.596 --> 00:20:28.976 A:middle
looking for.

00:20:29.176 --> 00:20:30.226 A:middle
In this case we're looking

00:20:30.226 --> 00:20:34.966 A:middle
for the location
ISO 6709 identifier.

00:20:34.966 --> 00:20:37.516 A:middle
So once we've found it we're
good to go and we can resume

00:20:37.516 --> 00:20:39.016 A:middle
with the code on
the previous slide.

00:20:39.566 --> 00:20:42.296 A:middle
So that's how QuickTime
Player is drawing the map

00:20:42.296 --> 00:20:45.046 A:middle
or drawing the path on the
map before you start playback.

00:20:45.676 --> 00:20:48.256 A:middle
The other thing that QuickTime
Player does, as you saw,

00:20:48.256 --> 00:20:50.886 A:middle
is it can update the current
location while you're doing

00:20:50.886 --> 00:20:53.456 A:middle
playback or even scrubbing
around and the way it does

00:20:53.526 --> 00:20:57.246 A:middle
that while it's already playing
the asset using an AVPlayerItem

00:20:57.556 --> 00:20:59.556 A:middle
and we're going to
use a new class called

00:20:59.556 --> 00:21:03.456 A:middle
AVPlayerItemMetadataOutput that
you attach to your PlayerItem,

00:21:03.766 --> 00:21:06.196 A:middle
which also notes how to
vend this data in the form

00:21:06.196 --> 00:21:07.406 A:middle
of TimedMetadataGroups.

00:21:07.706 --> 00:21:10.456 A:middle
But unlike the asset reader,
instead of getting all the data

00:21:10.456 --> 00:21:12.196 A:middle
up front you're going
to be getting it piece

00:21:12.196 --> 00:21:13.936 A:middle
by piece as the movie plays.

00:21:14.436 --> 00:21:16.526 A:middle
So a little bit of code,

00:21:16.826 --> 00:21:18.856 A:middle
you first create your
metadata output using the

00:21:18.856 --> 00:21:20.356 A:middle
initWithIdentifiers method

00:21:20.586 --> 00:21:23.956 A:middle
and in this case we're only
interested in metadata that has

00:21:23.956 --> 00:21:27.096 A:middle
that location identifier so
that's all we're going to get

00:21:27.096 --> 00:21:28.436 A:middle
by opting into this way.

00:21:29.086 --> 00:21:31.646 A:middle
Then you create a
delegate that you define

00:21:31.916 --> 00:21:32.816 A:middle
and that's what's going

00:21:32.816 --> 00:21:35.416 A:middle
to receive the metadata
during playback and you set

00:21:35.416 --> 00:21:36.516 A:middle
that delegate on your output

00:21:36.516 --> 00:21:40.256 A:middle
and tell us what cue you
want us to send the data on.

00:21:41.476 --> 00:21:45.376 A:middle
Then you create or grab your
AVPlayerItem and call addOutput

00:21:45.376 --> 00:21:48.296 A:middle
to attach your output, to attach
your output to the playerItem

00:21:48.456 --> 00:21:52.676 A:middle
and finally make your player
and associate your item

00:21:52.676 --> 00:21:55.106 A:middle
with the player as the current
item and start playback.

00:21:55.596 --> 00:21:58.106 A:middle
It's important to get the
smoothest playback experience

00:21:58.106 --> 00:22:01.116 A:middle
possible, we highly recommend
that you do all of this sort

00:22:01.116 --> 00:22:03.466 A:middle
of setup work before
you start playback

00:22:03.466 --> 00:22:05.636 A:middle
or even attach the
item to the player.

00:22:06.186 --> 00:22:12.266 A:middle
So a little bit of look at
what your delegate method might

00:22:12.266 --> 00:22:12.796 A:middle
look like.

00:22:13.316 --> 00:22:15.966 A:middle
There's only one delegate
method; it's the metadataOutput,

00:22:15.966 --> 00:22:19.146 A:middle
didOutputTimedMetadataGroups,
fromPlayerItemTrack method.

00:22:19.196 --> 00:22:21.536 A:middle
And the first thing you
want to do is grab an item

00:22:21.536 --> 00:22:23.336 A:middle
that you can get your
payload data from.

00:22:23.666 --> 00:22:25.046 A:middle
In this case, to
keep things simple,

00:22:25.046 --> 00:22:27.956 A:middle
I'm just grabbing the first item
from the first group but keep

00:22:27.956 --> 00:22:29.636 A:middle
in mind there could
be multiple items,

00:22:29.636 --> 00:22:31.066 A:middle
there could even
be multiple groups.

00:22:31.426 --> 00:22:33.446 A:middle
One reason there could
be multiple groups given

00:22:33.446 --> 00:22:38.456 A:middle
to this method is that the
metadata output will keep track

00:22:38.456 --> 00:22:41.216 A:middle
of whether the metadata
is coming faster

00:22:41.216 --> 00:22:43.736 A:middle
than you're processing it and,
if it is, it will start to batch

00:22:43.736 --> 00:22:46.706 A:middle
that up and give you
the metadata in batches

00:22:46.706 --> 00:22:48.696 A:middle
when you're done with the
previous batch of metadata.

00:22:49.306 --> 00:22:51.916 A:middle
So moving on with your
item; you're going

00:22:51.916 --> 00:22:55.076 A:middle
to do this
LoadValueAsynchronouslyForKeys

00:22:55.116 --> 00:22:56.556 A:middle
dance that we talked
about before.

00:22:56.786 --> 00:22:59.576 A:middle
In this case, we're
interested in the value

00:22:59.826 --> 00:23:01.386 A:middle
and data type properties
so we're going

00:23:01.386 --> 00:23:02.196 A:middle
to load both of those.

00:23:02.716 --> 00:23:05.336 A:middle
I've admitted the error
checking for brevity here

00:23:05.336 --> 00:23:07.326 A:middle
which you'll probably want
to do that error checking

00:23:07.326 --> 00:23:08.496 A:middle
like we had in the other slide.

00:23:09.126 --> 00:23:12.966 A:middle
And once we have the completion
handler we can ask the item

00:23:12.966 --> 00:23:16.276 A:middle
for its data type and make
sure that's the data type we're

00:23:16.276 --> 00:23:18.816 A:middle
prepared to handle, in this
case my code only knows how

00:23:18.816 --> 00:23:23.096 A:middle
to handle location information
in ISO 6709 format so we got

00:23:23.096 --> 00:23:26.416 A:middle
to make sure that's the right
data type and from there we go

00:23:26.416 --> 00:23:28.146 A:middle
and dispatch our code
to the main thread

00:23:28.146 --> 00:23:29.566 A:middle
that will update our UI.

00:23:29.856 --> 00:23:34.966 A:middle
So that's how QuickTime Player
is updating the location

00:23:35.396 --> 00:23:36.726 A:middle
metadata during playback.

00:23:37.366 --> 00:23:40.506 A:middle
Of course this is not the
first API that we have offered

00:23:40.506 --> 00:23:42.466 A:middle
for reading timed
metadata during playback.

00:23:43.196 --> 00:23:46.096 A:middle
There is an existing
property called timedMetadata

00:23:46.096 --> 00:23:48.516 A:middle
on AVPlayerItem but
I'm here to say

00:23:48.516 --> 00:23:50.276 A:middle
that the
AVPlayerItemMetadataOutput

00:23:50.276 --> 00:23:54.196 A:middle
replaces that property for
all of these use cases.

00:23:55.386 --> 00:23:57.686 A:middle
Now we're not deprecating
the property yet

00:23:57.966 --> 00:24:01.066 A:middle
but we do recommend, if
you're new to timed metadata,

00:24:01.066 --> 00:24:03.356 A:middle
just adopt the metadataOutput

00:24:03.356 --> 00:24:04.626 A:middle
and not worry about
the property.

00:24:05.126 --> 00:24:09.066 A:middle
If you're already using the
property version we do recommend

00:24:09.066 --> 00:24:12.726 A:middle
that you move over but just you
know that you should make sure

00:24:12.726 --> 00:24:16.206 A:middle
that your code is working
properly after that transition,

00:24:16.446 --> 00:24:17.506 A:middle
in particular I'll point

00:24:17.506 --> 00:24:21.596 A:middle
out that the metadataOutput
will give you, for certain kinds

00:24:21.596 --> 00:24:26.026 A:middle
of HLS content, will give
more specific identifiers

00:24:26.366 --> 00:24:27.926 A:middle
than the old property did.

00:24:27.926 --> 00:24:30.556 A:middle
So just make sure your code
is prepared to handle that.

00:24:31.386 --> 00:24:35.536 A:middle
The last topic on reading
timed metadata is Chapters.

00:24:36.066 --> 00:24:38.386 A:middle
Chapters, like I said, have
been supported for some time;

00:24:38.386 --> 00:24:39.816 A:middle
they even have their own API:

00:24:40.336 --> 00:24:43.076 A:middle
chapterMetadataGroupsBest
MatchingPreferredLanguages.

00:24:43.146 --> 00:24:44.766 A:middle
This is on AVAsset.

00:24:45.636 --> 00:24:48.926 A:middle
This will give you an array
of timed metadata groups

00:24:49.296 --> 00:24:52.286 A:middle
that contain items
with the identifier,

00:24:52.286 --> 00:24:55.766 A:middle
QuickTimeUserDataChapter,
and we've supported this

00:24:55.766 --> 00:24:59.686 A:middle
for some time for QuickTime
movie files and M4Vs and,

00:24:59.686 --> 00:25:05.776 A:middle
new in iOS 8 is the-and OS X
Yosemite-is support for chapters

00:25:05.776 --> 00:25:08.936 A:middle
in HTTP Live Streams
as well as MP3 files.

00:25:09.176 --> 00:25:10.356 A:middle
And I'll tell you more about how

00:25:10.356 --> 00:25:13.766 A:middle
to author those HLS chapters
in just a little bit.

00:25:14.566 --> 00:25:17.516 A:middle
So for more information,
we have some sample code

00:25:17.516 --> 00:25:20.916 A:middle
that does approximately what
QuickTime Player is doing,

00:25:21.416 --> 00:25:24.326 A:middle
where it can show your
location during play back.

00:25:24.756 --> 00:25:28.716 A:middle
We also have a previous session
about AssetReader that goes

00:25:28.716 --> 00:25:31.736 A:middle
into much more detail than I did
here, called "Working with Media

00:25:31.736 --> 00:25:34.476 A:middle
in AVFoundation" from 2011.

00:25:34.506 --> 00:25:36.836 A:middle
So that's how you read and
play back timed metadata.

00:25:37.636 --> 00:25:40.776 A:middle
Our next timed metadata topic
is how you can create your own

00:25:40.776 --> 00:25:42.536 A:middle
movies that contain
timed metadata.

00:25:43.116 --> 00:25:45.056 A:middle
We saw the screenshot
before and I mentioned

00:25:45.106 --> 00:25:48.796 A:middle
that these annotations are
stored as timed metadata and,

00:25:48.876 --> 00:25:51.696 A:middle
to show you this demo app, I'd
like to invite Shalini back

00:25:51.696 --> 00:25:53.396 A:middle
up on stage to demo it.

00:25:54.216 --> 00:25:56.396 A:middle
&gt;&gt; This time let's
look at an app on how

00:25:56.396 --> 00:25:59.816 A:middle
to author your own custom
metadata movie files.

00:26:00.356 --> 00:26:04.266 A:middle
Here I have a video and if I
would like to share some notes

00:26:04.476 --> 00:26:07.706 A:middle
with my friend, who is good
at fixing colors in a movie,

00:26:07.936 --> 00:26:11.246 A:middle
I can now do that
within the app.

00:26:11.516 --> 00:26:15.066 A:middle
To add annotations, I
use a two-finger gesture,

00:26:15.306 --> 00:26:22.096 A:middle
I can use a pinch gesture to
resize and then add a comment

00:26:24.156 --> 00:26:28.266 A:middle
which is enough for my whoever
looks at the video later

00:26:28.396 --> 00:26:31.786 A:middle
to fix the colors there
and then I begin playback.

00:26:33.296 --> 00:26:36.366 A:middle
And as playback progresses,
I track the circle

00:26:37.116 --> 00:26:39.246 A:middle
to where I want this
to be fixed.

00:26:39.926 --> 00:26:43.206 A:middle
And now that I have this
annotation and I can write it

00:26:43.206 --> 00:26:46.626 A:middle
out along with the audio and
video to do that, I hit "export"

00:26:47.996 --> 00:26:51.076 A:middle
and now we see an AV
player view controller

00:26:51.076 --> 00:26:54.256 A:middle
which shows the exported
movie along with the metadata

00:26:54.256 --> 00:26:55.216 A:middle
which was written to it.

00:26:55.586 --> 00:27:00.556 A:middle
So if I start playback you see
the annotation is moving along

00:27:00.556 --> 00:27:04.476 A:middle
the timeline in the
part in which I traced.

00:27:04.906 --> 00:27:09.996 A:middle
So if I scrub back in time you
can see the annotation moving.

00:27:10.336 --> 00:27:12.646 A:middle
You might wonder that
the annotation is baked

00:27:12.646 --> 00:27:14.126 A:middle
into the video frame; it is not.

00:27:15.346 --> 00:27:19.286 A:middle
It is being rendered real-time
using AVPlayerItemMetadataOutput

00:27:19.886 --> 00:27:23.586 A:middle
and you can change the color
or the font of the annotation.

00:27:24.016 --> 00:27:27.356 A:middle
So if I begin playback, you
see the rendering is happening

00:27:27.356 --> 00:27:31.266 A:middle
in real time.

00:27:31.266 --> 00:27:34.656 A:middle
That's AVTimedAnnotationWriter,
we have this available

00:27:34.656 --> 00:27:36.846 A:middle
as a sample code
as well, thank you.

00:27:36.846 --> 00:27:38.946 A:middle
&gt;&gt; So that was a
great demonstration

00:27:38.946 --> 00:27:42.836 A:middle
of not only the playback part
of it but also how to write

00:27:42.836 --> 00:27:45.206 A:middle
that data into the file,
so let's take a look at how

00:27:45.206 --> 00:27:46.056 A:middle
that was accomplished.

00:27:46.056 --> 00:27:50.296 A:middle
So we're going to use an
AVAssetWriter to write the file

00:27:50.626 --> 00:27:53.596 A:middle
and we're going to use an
AVAssetWriterInput in order

00:27:53.596 --> 00:27:55.816 A:middle
to write that metadata
track to the file.

00:27:55.816 --> 00:27:58.056 A:middle
Just like the reader side,

00:27:58.336 --> 00:28:01.736 A:middle
the writer has a new class
that's a metadataAdaptor

00:28:02.266 --> 00:28:04.976 A:middle
and that class knows how
to interpret instances

00:28:04.976 --> 00:28:08.286 A:middle
of AVTimedMetadataGroup and
write that into the file.

00:28:08.286 --> 00:28:12.866 A:middle
See a little bit of code;
first thing we're going

00:28:12.866 --> 00:28:15.666 A:middle
to do is create our
AssetWriter Input.

00:28:15.666 --> 00:28:20.046 A:middle
We're going to use the media
type AVMediaTypeMetadata,

00:28:20.286 --> 00:28:23.026 A:middle
once again nil outputSettings
and we're going to have

00:28:23.026 --> 00:28:26.396 A:middle
to provide a clue to
the source format, well,

00:28:26.396 --> 00:28:28.496 A:middle
the format of the data that
we're going to be appending.

00:28:28.496 --> 00:28:30.086 A:middle
We'll talk more about this

00:28:30.176 --> 00:28:32.126 A:middle
and why it's required
on the next slide.

00:28:32.736 --> 00:28:34.676 A:middle
Then you simply create
your metadataAdaptor

00:28:34.676 --> 00:28:38.526 A:middle
with the reference to that
input and, as you generate

00:28:38.526 --> 00:28:40.506 A:middle
or receive your timed
metadata groups,

00:28:40.906 --> 00:28:43.666 A:middle
you simply use the
appendTimedMetadataGroup method

00:28:43.926 --> 00:28:47.416 A:middle
to continue to append those
and write them to the file.

00:28:47.646 --> 00:28:50.306 A:middle
So what's the deal with
that source format thing.

00:28:50.856 --> 00:28:55.476 A:middle
Well, it turns out in order
for AVAssetWriter to be able

00:28:55.476 --> 00:28:59.036 A:middle
to write your metadata in the
most efficient way possible,

00:28:59.196 --> 00:29:01.566 A:middle
it needs to know up
front exactly what kind

00:29:01.566 --> 00:29:02.936 A:middle
of metadata it is
going to be writing.

00:29:03.756 --> 00:29:08.556 A:middle
This will result in the most
lowest storage overhead in terms

00:29:08.556 --> 00:29:10.176 A:middle
of the number of bytes
your file takes up

00:29:10.176 --> 00:29:13.376 A:middle
and it also has a effect
on how efficient it is

00:29:13.376 --> 00:29:15.546 A:middle
to play back this
kind of contents.

00:29:15.546 --> 00:29:17.116 A:middle
You don't want to be
using too much power

00:29:17.426 --> 00:29:19.436 A:middle
when you're playing this
kind of content back.

00:29:19.606 --> 00:29:21.486 A:middle
So you do have some
options in terms

00:29:21.486 --> 00:29:24.046 A:middle
of how you actually construct
one of these format hits.

00:29:24.796 --> 00:29:25.586 A:middle
If you're reading

00:29:25.586 --> 00:29:28.566 A:middle
from AVAssetReader you
can actually ask the track

00:29:28.566 --> 00:29:30.306 A:middle
that you are reading
from to give you its list

00:29:30.306 --> 00:29:33.136 A:middle
of format descriptions
and use one of those.

00:29:33.936 --> 00:29:36.806 A:middle
If you're creating the metadata
group yourself or getting it

00:29:36.806 --> 00:29:40.386 A:middle
from some other source then
you can use a new method called

00:29:40.386 --> 00:29:43.446 A:middle
copyFormatDescription that
will give you back an instance

00:29:43.446 --> 00:29:46.166 A:middle
of CM format description that
will do this job for you.

00:29:46.776 --> 00:29:49.086 A:middle
It's important to note that
if you go this route you need

00:29:49.086 --> 00:29:50.376 A:middle
to make sure that the contents

00:29:50.376 --> 00:29:53.276 A:middle
of your metadata group
are comprehensive in terms

00:29:53.276 --> 00:29:55.766 A:middle
of it containing
every combination

00:29:55.766 --> 00:29:58.926 A:middle
of identifier data
type and language tag

00:29:58.926 --> 00:30:00.496 A:middle
that you are going
to be appending.

00:30:00.746 --> 00:30:03.946 A:middle
That is. it contains an item
with each of those combinations.

00:30:04.626 --> 00:30:07.976 A:middle
Of course, since the CM format
description is a CF type,

00:30:08.266 --> 00:30:10.006 A:middle
you'll need a CFRelease
app when you're done.

00:30:10.746 --> 00:30:12.846 A:middle
Of course, there's one
more way you can do this:

00:30:12.846 --> 00:30:15.166 A:middle
you can create the format
description directly using

00:30:15.166 --> 00:30:16.336 A:middle
CoreMedia APIs.

00:30:16.666 --> 00:30:21.016 A:middle
And here you use this long name
CMMetadataFormatDescription

00:30:21.016 --> 00:30:23.496 A:middle
CreateWith
MetadataSpecifications function.

00:30:23.536 --> 00:30:26.386 A:middle
You're going to pass in
the metadataType box.

00:30:26.386 --> 00:30:28.096 A:middle
That's the sort of
metadata we've been talking

00:30:28.096 --> 00:30:29.976 A:middle
about this whole time
with timed metadata.

00:30:31.056 --> 00:30:34.006 A:middle
And these metadata
specifications it's just an

00:30:34.006 --> 00:30:35.086 A:middle
array of dictionaries.

00:30:35.576 --> 00:30:38.626 A:middle
Each dictionary contains those
combinations I was talking

00:30:38.626 --> 00:30:39.306 A:middle
about before.

00:30:39.306 --> 00:30:43.226 A:middle
The identifier dataType and
optionally extended language tag

00:30:43.526 --> 00:30:46.736 A:middle
so you want to make one of
these metadata specifications

00:30:46.736 --> 00:30:49.386 A:middle
dictionaries for each
combination you plan to append.

00:30:50.556 --> 00:30:54.106 A:middle
So the one thing that was not
obvious about that demo is

00:30:54.236 --> 00:30:58.016 A:middle
that we're actually writing
metadata timed metadata

00:30:58.016 --> 00:31:00.656 A:middle
that describes one
particular other track.

00:31:01.106 --> 00:31:03.116 A:middle
So for the example
of these annotations,

00:31:03.116 --> 00:31:06.076 A:middle
we're really just talking about
the video track of the movie

00:31:06.076 --> 00:31:08.656 A:middle
and not the sound or
anything else like that.

00:31:08.716 --> 00:31:13.766 A:middle
So just like we had a way of
making track-specific metadata

00:31:13.766 --> 00:31:15.256 A:middle
that applied to the
entire track,

00:31:15.256 --> 00:31:16.526 A:middle
with those tagged
characteristics

00:31:16.526 --> 00:31:18.806 A:middle
that we saw before, you
also have the ability

00:31:18.806 --> 00:31:21.466 A:middle
to formerly mark
your metadata track

00:31:21.676 --> 00:31:24.066 A:middle
as describing one
particular other track.

00:31:24.686 --> 00:31:27.246 A:middle
You do that with the
addTrackAssociationWith

00:31:27.246 --> 00:31:31.326 A:middle
TrackOfInput method using as the
parameter the AssetWriterInput

00:31:31.326 --> 00:31:33.016 A:middle
that you are using to
write your video track.

00:31:33.226 --> 00:31:35.406 A:middle
And your receiver is the
input that you are using

00:31:35.406 --> 00:31:36.546 A:middle
to write your metadata track.

00:31:36.936 --> 00:31:39.126 A:middle
You use the
AssociationTypeMetadataReferent.

00:31:39.916 --> 00:31:43.186 A:middle
So that's how your create
metadata that's timed

00:31:43.186 --> 00:31:45.326 A:middle
but also specific to
a particular track.

00:31:46.096 --> 00:31:49.326 A:middle
The next thing we did that was
interesting in that demo is

00:31:49.326 --> 00:31:51.706 A:middle
that we actually used our
own custom identifiers.

00:31:51.706 --> 00:31:53.986 A:middle
So we had that big list
of built in identifiers.

00:31:54.246 --> 00:31:55.406 A:middle
Well, you don't have
to use those;

00:31:55.406 --> 00:31:56.636 A:middle
you can actually build your own

00:31:57.036 --> 00:31:59.836 A:middle
and as I mentioned before an
identifier is just a combination

00:31:59.836 --> 00:32:02.866 A:middle
of key space and key and
it has a particular format:

00:32:02.866 --> 00:32:04.936 A:middle
it's just a string but it
is in a particular format

00:32:05.246 --> 00:32:07.336 A:middle
so to help you make your
own custom identifiers,

00:32:07.336 --> 00:32:10.256 A:middle
we have this method,
identifierFor Key, and keySpace,

00:32:10.326 --> 00:32:14.086 A:middle
it's a class method
on AVMetadataItem.

00:32:14.086 --> 00:32:17.476 A:middle
There are some rules to
follow: your key space needs

00:32:17.476 --> 00:32:19.326 A:middle
to be four characters
long if you want to use it

00:32:19.326 --> 00:32:20.376 A:middle
for timed metadata

00:32:20.696 --> 00:32:22.996 A:middle
so we actually recommend you
use our built-in key space,

00:32:23.106 --> 00:32:24.836 A:middle
the QuickTimeMetadata keySpace.

00:32:25.376 --> 00:32:28.816 A:middle
We also highly recommend
you use reverse DNS notation

00:32:28.816 --> 00:32:30.776 A:middle
for your custom keys
to avoid collisions

00:32:31.026 --> 00:32:32.636 A:middle
with other kinds of metadata.

00:32:32.806 --> 00:32:36.256 A:middle
So a brief code snippet you
can see you can simply use this

00:32:36.256 --> 00:32:39.666 A:middle
method to make your custom
identifier and then set

00:32:39.666 --> 00:32:42.536 A:middle
that on the identifier property
of your mutableMetadataItem.

00:32:42.936 --> 00:32:46.936 A:middle
So in addition to custom
identifiers you can also create

00:32:46.936 --> 00:32:48.346 A:middle
your own custom data types.

00:32:49.966 --> 00:32:52.746 A:middle
So we're all familiar by now,
through this presentation,

00:32:52.746 --> 00:32:55.026 A:middle
with some of the built-in
data types that we defined;

00:32:55.256 --> 00:32:56.306 A:middle
there's a lot more than these

00:32:56.306 --> 00:32:58.266 A:middle
but we've been using these
quite heavily already.

00:32:58.266 --> 00:33:00.256 A:middle
These are really useful

00:33:00.256 --> 00:33:02.656 A:middle
but sometimes you want
your data type information

00:33:02.656 --> 00:33:05.896 A:middle
to express more, maybe about
the domain you're working in,

00:33:06.616 --> 00:33:08.956 A:middle
so if you are doing a serial
number or a bar code kind

00:33:08.956 --> 00:33:10.156 A:middle
of thing you might want

00:33:10.156 --> 00:33:13.236 A:middle
to define a data type that's
this sort of serial number

00:33:13.236 --> 00:33:17.196 A:middle
as string data type or
barcode image as JPEG data type

00:33:17.326 --> 00:33:19.066 A:middle
so you have more
specific information

00:33:19.066 --> 00:33:20.966 A:middle
about what your metadata
actually contains.

00:33:21.576 --> 00:33:26.136 A:middle
The way that this works is,
you have to tell us exactly how

00:33:26.136 --> 00:33:30.596 A:middle
to serialize that custom
data type and the way you do

00:33:30.596 --> 00:33:33.516 A:middle
that is you tell us that your
custom data type conforms to one

00:33:33.516 --> 00:33:34.836 A:middle
of our built-in data types.

00:33:35.346 --> 00:33:37.796 A:middle
So in this case the
serial number conforms

00:33:37.846 --> 00:33:41.736 A:middle
to the UTF8 data type so under
the hood it's UTF8 string,

00:33:41.736 --> 00:33:44.986 A:middle
but we know that it really
represents a serial number

00:33:45.276 --> 00:33:46.716 A:middle
and the same with
the barcode image.

00:33:47.126 --> 00:33:49.926 A:middle
The way that you do this is you
register your data type using

00:33:49.926 --> 00:33:54.266 A:middle
the CMMetadataDataTypeRegistry
RegisterDataType function that's

00:33:54.266 --> 00:33:55.256 A:middle
defined in Core Media.

00:33:55.776 --> 00:33:58.716 A:middle
You can't create your
own custom base types

00:33:59.206 --> 00:34:03.816 A:middle
but you can create your own
custom type that conforms

00:34:03.816 --> 00:34:06.556 A:middle
to our raw data built-in type

00:34:06.556 --> 00:34:10.146 A:middle
if your data type really is
just a custom sequence of bytes.

00:34:11.396 --> 00:34:14.236 A:middle
So there are some rules
to using AVAssetWriter

00:34:14.386 --> 00:34:17.056 A:middle
for writing timed metadata.

00:34:17.056 --> 00:34:20.756 A:middle
Most importantly, every metadata
item that you append has

00:34:20.756 --> 00:34:24.226 A:middle
to have non-nil values for
identifier, data type and value.

00:34:24.226 --> 00:34:28.836 A:middle
Your identifier has to conform
to the format that we specify,

00:34:28.836 --> 00:34:31.076 A:middle
so we highly recommend
using that utility method

00:34:31.076 --> 00:34:31.856 A:middle
that we just talked about.

00:34:32.666 --> 00:34:34.986 A:middle
The value has to be
compatible with the data type

00:34:35.046 --> 00:34:39.106 A:middle
so you can tell us that your
NSString value is an UTF8 string

00:34:39.396 --> 00:34:40.336 A:middle
but don't try telling us

00:34:40.386 --> 00:34:43.806 A:middle
that your custom class is a UTF8
string because we won't know how

00:34:43.806 --> 00:34:47.056 A:middle
to serialize that properly
and the AssetWriter will fail.

00:34:47.516 --> 00:34:50.756 A:middle
As I mentioned before, you have
to create your AssetWriterInput

00:34:50.756 --> 00:34:53.056 A:middle
with a format hint and
that must be comprehensive

00:34:53.416 --> 00:34:54.666 A:middle
and we described that before.

00:34:54.766 --> 00:34:57.646 A:middle
So the last topic
about AssetWriter

00:34:57.646 --> 00:35:01.886 A:middle
and timed metadata is a recipe
for creating your own movies

00:35:02.156 --> 00:35:04.206 A:middle
that have the same sort
of dynamic location

00:35:04.206 --> 00:35:05.676 A:middle
that we've seen a
couple of times already.

00:35:06.706 --> 00:35:09.706 A:middle
To do this, you can
use AVCapture audio

00:35:09.706 --> 00:35:12.456 A:middle
and video data outputs
and target that data

00:35:12.456 --> 00:35:15.436 A:middle
at twin instances of
AssetWriterInput and,

00:35:15.506 --> 00:35:19.736 A:middle
at the same time, grab
information from Core Location

00:35:19.736 --> 00:35:22.266 A:middle
that represents the location
information and write

00:35:22.266 --> 00:35:23.906 A:middle
that to its own
AssetWriterInput.

00:35:24.766 --> 00:35:28.676 A:middle
For more detail about how to do
that we've actually implemented

00:35:28.676 --> 00:35:30.546 A:middle
that and made it
available as sample code,

00:35:30.846 --> 00:35:34.436 A:middle
so see AVCaptureLocation if you
want to make your own movies

00:35:34.436 --> 00:35:35.986 A:middle
that contain dynamic location.

00:35:36.626 --> 00:35:39.116 A:middle
We also have sample code
as Shalini mentioned

00:35:39.116 --> 00:35:40.416 A:middle
for the demo we just showed you,

00:35:40.686 --> 00:35:42.776 A:middle
that's called
AVTimedAnnotationWriter.

00:35:43.106 --> 00:35:45.376 A:middle
And, of course, for more
information about AssetWriter

00:35:45.376 --> 00:35:48.146 A:middle
in general, see that same
talk I referenced earlier:

00:35:48.146 --> 00:35:50.326 A:middle
"Working with Media
in AVFoundation".

00:35:51.096 --> 00:35:54.726 A:middle
Last two quick topics about
timed metadata: ExportSession.

00:35:55.366 --> 00:35:57.966 A:middle
Just like we've said the
asset ExportSession will

00:35:57.966 --> 00:36:01.456 A:middle
by default pass through any
of your metadata that applies

00:36:01.456 --> 00:36:04.436 A:middle
to the entire asset or
entire track, it will pass

00:36:04.496 --> 00:36:06.356 A:middle
that through, copy it
to the output file.

00:36:06.626 --> 00:36:09.376 A:middle
It will do the same thing with
timed metadata that exists

00:36:09.376 --> 00:36:11.126 A:middle
in the source file provided

00:36:11.126 --> 00:36:13.786 A:middle
that your destination file
type is QuickTime Movie.

00:36:14.046 --> 00:36:16.916 A:middle
We'll talk more about file
types in just a little bit

00:36:17.316 --> 00:36:20.596 A:middle
but basically ExportSession
behaves exactly

00:36:20.596 --> 00:36:21.466 A:middle
as you would expect.

00:36:22.526 --> 00:36:27.396 A:middle
In our last timed metadata
authoring topic is HTTP Live

00:36:27.396 --> 00:36:30.536 A:middle
Streaming chapters so if
you want to author chapters

00:36:30.536 --> 00:36:34.556 A:middle
in your HLS stream, you can use
the session-data tag we talked

00:36:34.556 --> 00:36:40.386 A:middle
about earlier and the special
data ID, com.apple.hls.chapters.

00:36:40.826 --> 00:36:43.296 A:middle
Your URL should point
to a JSON file

00:36:43.476 --> 00:36:47.346 A:middle
that describes the chapter
information for that stream and,

00:36:47.346 --> 00:36:50.066 A:middle
of course for more detail
on this, see that same link

00:36:50.066 --> 00:36:53.166 A:middle
that I referenced earlier
for HTTP Live Streaming.

00:36:53.446 --> 00:36:55.716 A:middle
All right, so that
is timed metadata,

00:36:55.716 --> 00:36:57.326 A:middle
our next topic is privacy.

00:36:58.066 --> 00:37:00.546 A:middle
Why is privacy important
in this context?

00:37:00.546 --> 00:37:04.446 A:middle
Well, any time that you
are writing your users data

00:37:04.446 --> 00:37:07.856 A:middle
to a file you need to
be at least considerate

00:37:07.856 --> 00:37:12.546 A:middle
about their privacy and be aware
that the metadata that you write

00:37:12.546 --> 00:37:15.926 A:middle
out to these movie files can
contain user identifiable

00:37:15.926 --> 00:37:19.176 A:middle
information, the most obvious
example of that is location.

00:37:19.836 --> 00:37:23.696 A:middle
And so because movie files
can be distributed and we want

00:37:23.696 --> 00:37:25.446 A:middle
to protect the privacy
of our users,

00:37:26.136 --> 00:37:29.776 A:middle
for our built-in sharing
services, we do our best

00:37:29.776 --> 00:37:33.276 A:middle
to strip out any potentially
user identifiable information,

00:37:33.336 --> 00:37:36.356 A:middle
such as this location and we
recommend that you do the same.

00:37:36.686 --> 00:37:38.046 A:middle
So we've given you a utility

00:37:38.046 --> 00:37:41.736 A:middle
for that called
AVMetadataItemFilter.

00:37:42.276 --> 00:37:44.716 A:middle
Right now there is only one
filter that we make available

00:37:44.716 --> 00:37:46.316 A:middle
but it is geared
towards privacy,

00:37:46.316 --> 00:37:49.686 A:middle
it is the metadata item filter
for sharing and that will strip

00:37:49.686 --> 00:37:52.716 A:middle
out any of this sort of
user identifying information

00:37:52.716 --> 00:37:55.086 A:middle
that we're talking about;
location is only one example.

00:37:55.086 --> 00:37:57.986 A:middle
But it will also strip out
anything it doesn't recognize,

00:37:58.016 --> 00:37:59.186 A:middle
because it doesn't know whether

00:37:59.186 --> 00:38:02.126 A:middle
that might contain user
identifiable information.

00:38:02.126 --> 00:38:05.356 A:middle
So that includes any
metadata that uses identifiers

00:38:05.356 --> 00:38:06.536 A:middle
that you define yourself.

00:38:07.306 --> 00:38:11.476 A:middle
It will leave in some things
like metadata that's important

00:38:11.476 --> 00:38:12.656 A:middle
to the structure of the movie

00:38:12.656 --> 00:38:14.746 A:middle
and chapters are the
best example of that,

00:38:15.166 --> 00:38:18.166 A:middle
and also any commercial
related data like your Apple ID.

00:38:19.406 --> 00:38:23.776 A:middle
So to use the MetadataItemFilter
you're going to first

00:38:23.776 --> 00:38:27.986 A:middle
of all create your filter and
feed it your original array

00:38:27.986 --> 00:38:31.296 A:middle
of metadata items using
this metadataItemsFromArray

00:38:31.296 --> 00:38:33.656 A:middle
filteredByMetadataItemFilter
method.

00:38:33.966 --> 00:38:36.696 A:middle
This is a companion to that
other filtering method based

00:38:36.696 --> 00:38:38.406 A:middle
on identifiers we've
been using all day

00:38:39.276 --> 00:38:41.666 A:middle
and then once you have
your filtered array

00:38:41.746 --> 00:38:45.686 A:middle
of metadata items just set
that on your AssetWriter

00:38:45.686 --> 00:38:47.566 A:middle
or ExportSession as
you normally would.

00:38:47.916 --> 00:38:49.976 A:middle
Well actually I mentioned
ExportSession

00:38:49.976 --> 00:38:53.006 A:middle
but things can be simple if
you're using the ExportSession

00:38:53.006 --> 00:38:56.646 A:middle
and only want to
copy the metadata

00:38:56.766 --> 00:38:59.046 A:middle
from the source asset
and not add your own.

00:38:59.356 --> 00:39:01.606 A:middle
You just set the filter
on the ExportSession

00:39:01.606 --> 00:39:03.326 A:middle
and it will actually do
the filtering for you,

00:39:03.976 --> 00:39:07.186 A:middle
this will filter both
static and timed metadata

00:39:07.186 --> 00:39:10.726 A:middle
but it will only filter the
metadata from the source asset.

00:39:10.726 --> 00:39:13.236 A:middle
If you set your own metadata
on the metadata property,

00:39:13.596 --> 00:39:16.146 A:middle
it won't filter that for you;
you'll need to do the process

00:39:16.146 --> 00:39:19.246 A:middle
that I just described of
doing the filtering yourself.

00:39:19.246 --> 00:39:20.726 A:middle
The only other thing
to keep in mind is

00:39:20.726 --> 00:39:22.456 A:middle
that the export may
take more time

00:39:22.696 --> 00:39:25.496 A:middle
when the filter is being used
because it has to go through

00:39:25.496 --> 00:39:27.356 A:middle
and examine all of
the metadata items.

00:39:27.876 --> 00:39:29.396 A:middle
So that's privacy.

00:39:30.196 --> 00:39:34.016 A:middle
Our last section of the talk
today is some assorted best

00:39:34.016 --> 00:39:36.366 A:middle
practices when you are
writing your own files

00:39:36.416 --> 00:39:37.636 A:middle
that contain metadata.

00:39:39.536 --> 00:39:42.436 A:middle
First up, what if you're
writing timed metadata

00:39:42.676 --> 00:39:45.986 A:middle
and you have multiple
streams of metadata

00:39:46.136 --> 00:39:47.686 A:middle
that use different identifiers.

00:39:48.256 --> 00:39:50.146 A:middle
How do you get those
into the same file?

00:39:50.146 --> 00:39:52.986 A:middle
Well, we actually have the
situation in the demo app,

00:39:53.206 --> 00:39:56.266 A:middle
we have that circle is comprised
of two different pieces

00:39:56.266 --> 00:39:59.096 A:middle
of information, the
position and the radius.

00:39:59.676 --> 00:40:02.406 A:middle
So we're representing these

00:40:02.406 --> 00:40:04.826 A:middle
and the demo app is two
distinct streams of metadata.

00:40:05.366 --> 00:40:07.666 A:middle
And so the most obvious way
I can think of to get this

00:40:07.666 --> 00:40:12.816 A:middle
into a file is to use two
different AVAssetWriterInputs,

00:40:13.186 --> 00:40:15.386 A:middle
which result in having
two metadata tracks

00:40:15.386 --> 00:40:17.046 A:middle
in the output file,
pretty simple.

00:40:17.466 --> 00:40:20.336 A:middle
But there is another
way you can do it,

00:40:20.336 --> 00:40:23.966 A:middle
you could instead combine those
two different types of metadata

00:40:23.966 --> 00:40:26.816 A:middle
into one timed metadata
group and write

00:40:26.816 --> 00:40:28.806 A:middle
that to a single
AssetWriterInput

00:40:28.806 --> 00:40:31.766 A:middle
and that will result in
only one metadata track

00:40:31.766 --> 00:40:34.576 A:middle
in the output file that contains
multiple different kinds

00:40:34.576 --> 00:40:35.366 A:middle
of identifiers.

00:40:35.876 --> 00:40:38.426 A:middle
There are some advantages to
this approach, not the least

00:40:38.426 --> 00:40:41.316 A:middle
of which is it can result
in lower storage overhead

00:40:41.626 --> 00:40:44.036 A:middle
and therefore as we always
see more efficient playback.

00:40:45.136 --> 00:40:48.246 A:middle
But there are of course
pros and cons to everything.

00:40:48.696 --> 00:40:50.976 A:middle
So you'll definitely want
to consider combining

00:40:51.216 --> 00:40:53.436 A:middle
into one track your
different metadata

00:40:53.616 --> 00:40:55.716 A:middle
if they are used
together during playback

00:40:56.316 --> 00:40:58.296 A:middle
and they have identical timing.

00:40:58.296 --> 00:41:00.616 A:middle
This is definitely the case
with the example we just saw

00:41:00.616 --> 00:41:03.046 A:middle
with the circle center
and the circle radius.

00:41:03.866 --> 00:41:07.096 A:middle
If these are not true then
you might not want to combine.

00:41:07.096 --> 00:41:09.346 A:middle
And in fact one instance where
you definitely do not want

00:41:09.346 --> 00:41:12.596 A:middle
to combine, is if
you have one type

00:41:12.596 --> 00:41:15.856 A:middle
of metadata that's associated
with another track in the file,

00:41:15.856 --> 00:41:18.346 A:middle
so that's like our
annotations are associated

00:41:18.416 --> 00:41:20.736 A:middle
with the video track, but
then you have another type

00:41:20.736 --> 00:41:23.466 A:middle
of metadata like location
that is associated

00:41:23.466 --> 00:41:24.756 A:middle
with the entire asset.

00:41:24.756 --> 00:41:27.316 A:middle
You don't want to combine
those into one track,

00:41:27.316 --> 00:41:31.836 A:middle
otherwise your location in that
example will become mistakenly

00:41:31.836 --> 00:41:33.406 A:middle
associated with just
the video track,

00:41:33.406 --> 00:41:34.746 A:middle
and that's not what you want.

00:41:35.006 --> 00:41:36.076 A:middle
So that's how to deal

00:41:36.076 --> 00:41:38.156 A:middle
with multiple streams
of timed metadata.

00:41:38.956 --> 00:41:43.466 A:middle
Next topic is duration of
your timed metadata groups,

00:41:44.216 --> 00:41:45.766 A:middle
when you get a timed
metadata group

00:41:45.766 --> 00:41:47.526 A:middle
from AVFoundation
it's always going

00:41:47.526 --> 00:41:51.466 A:middle
to have a fully formed
time range.

00:41:51.756 --> 00:41:54.456 A:middle
So that means it will have
a start time and a duration.

00:41:54.846 --> 00:41:57.426 A:middle
We actually recommend when you
make your own timed metadata

00:41:57.426 --> 00:41:59.906 A:middle
groups for a pending
with the AVAssetWriter

00:42:00.196 --> 00:42:02.236 A:middle
that you don't bother
giving us a duration.

00:42:02.636 --> 00:42:05.466 A:middle
And to see how that works,
here's an example of a group

00:42:05.466 --> 00:42:08.266 A:middle
that starts at time 0 but
it doesn't have a duration

00:42:08.266 --> 00:42:10.326 A:middle
so how do we know when it ends?

00:42:10.326 --> 00:42:12.536 A:middle
Well, of course we'll wait
until you append the next one

00:42:12.536 --> 00:42:15.596 A:middle
and then we'll say that,
"Okay, the end time

00:42:15.596 --> 00:42:17.696 A:middle
of the first group is the same

00:42:17.696 --> 00:42:19.386 A:middle
as the start time
of the next one."

00:42:19.906 --> 00:42:22.206 A:middle
So this ensures that your
metadata track is going

00:42:22.206 --> 00:42:27.636 A:middle
to have a continuous stream of
contiguous metadata and we think

00:42:27.636 --> 00:42:30.266 A:middle
that for most cases this is the
best way to store your metadata.

00:42:31.036 --> 00:42:32.916 A:middle
The way you accomplish this is,

00:42:32.916 --> 00:42:34.356 A:middle
when you're making
your time range,

00:42:34.576 --> 00:42:38.356 A:middle
you just use KCMTimeInvalid
for your duration

00:42:38.656 --> 00:42:39.956 A:middle
and we'll take care of the rest.

00:42:40.576 --> 00:42:43.846 A:middle
We do recognize that there are
cases where you might not want

00:42:43.846 --> 00:42:46.536 A:middle
to have contiguous
metadata, you might want

00:42:46.536 --> 00:42:50.246 A:middle
to author an explicit gap into
your metadata stream and so,

00:42:50.246 --> 00:42:52.246 A:middle
for that, our recommendation
is that you give us

00:42:52.656 --> 00:42:55.596 A:middle
in the middle there a group
that contains zero items.

00:42:55.746 --> 00:42:58.526 A:middle
This is the best way to
author a gap in the metadata.

00:42:58.526 --> 00:43:03.086 A:middle
And you can see we just do that
by presenting an empty array

00:43:03.166 --> 00:43:05.076 A:middle
when we're creating our
timed metadata group.

00:43:05.506 --> 00:43:08.636 A:middle
Notice that we're still
using KCMTimeInvalid

00:43:08.636 --> 00:43:09.876 A:middle
for our duration here.

00:43:10.326 --> 00:43:13.406 A:middle
Just tell us when the beginning
of the metadata silence,

00:43:13.406 --> 00:43:16.976 A:middle
so to speak, is and we'll figure
out how long it lasts based

00:43:16.976 --> 00:43:19.966 A:middle
on when you append your
next non-empty group.

00:43:20.566 --> 00:43:22.756 A:middle
So that's how you write
gaps in your metadata.

00:43:23.446 --> 00:43:24.946 A:middle
Our last best practice,

00:43:25.516 --> 00:43:27.346 A:middle
I mentioned output
file type before

00:43:27.636 --> 00:43:29.876 A:middle
and here's the longer
explanation.

00:43:30.916 --> 00:43:32.366 A:middle
Well, AssetWriter

00:43:32.366 --> 00:43:35.166 A:middle
and AssetExportSessions
support writing

00:43:35.166 --> 00:43:37.566 A:middle
to a wide variety of file types.

00:43:39.626 --> 00:43:42.376 A:middle
You've got QuickTime
movie, MPEG4, and all sorts

00:43:42.376 --> 00:43:44.916 A:middle
of other kind of file types

00:43:45.406 --> 00:43:49.426 A:middle
and those file types can carry
different kinds of metadata;

00:43:49.496 --> 00:43:51.746 A:middle
some have more restrictions
than others about what kind

00:43:51.746 --> 00:43:53.526 A:middle
of metadata can go
into that file type.

00:43:53.526 --> 00:43:57.246 A:middle
So the easiest situation, say
if you have an ExportSession

00:43:57.486 --> 00:44:01.546 A:middle
and you're going from one,
from the same file type

00:44:01.546 --> 00:44:02.946 A:middle
as your source to the output,

00:44:02.946 --> 00:44:05.436 A:middle
so for this example they're
both QuickTime movie files.

00:44:06.186 --> 00:44:08.426 A:middle
This is the easiest
way to ensure that all

00:44:08.426 --> 00:44:11.206 A:middle
of that data is actually going
to make it into the output file.

00:44:11.706 --> 00:44:14.476 A:middle
If instead you're using a
different output file type,

00:44:14.726 --> 00:44:16.536 A:middle
like MPEG4 in this example,

00:44:16.836 --> 00:44:19.626 A:middle
then some different things
are going to have to happen.

00:44:19.966 --> 00:44:22.306 A:middle
You notice those last few
items didn't quite make it

00:44:22.306 --> 00:44:23.276 A:middle
into the output file;

00:44:23.386 --> 00:44:25.626 A:middle
it's because they have no
equivalent representation

00:44:25.806 --> 00:44:27.716 A:middle
that works with an MPEG4 file.

00:44:28.576 --> 00:44:30.126 A:middle
If you're looking
closely you'll also notice

00:44:30.126 --> 00:44:32.356 A:middle
that those top two
items have changed,

00:44:32.886 --> 00:44:36.136 A:middle
although they sound very similar
they are slightly different

00:44:36.136 --> 00:44:38.406 A:middle
identifiers because that's
the kind of identifier

00:44:38.406 --> 00:44:39.396 A:middle
that works with MPEG4.

00:44:39.396 --> 00:44:43.836 A:middle
So both AssetExportSession and
AssetWriter will do the sort

00:44:43.836 --> 00:44:44.906 A:middle
of three step process.

00:44:45.346 --> 00:44:48.876 A:middle
First, they'll try to pass
that data through directly

00:44:49.196 --> 00:44:52.986 A:middle
if possible and, if not, they'll
try to convert the identifier

00:44:52.986 --> 00:44:54.706 A:middle
into an equivalent
representation

00:44:54.866 --> 00:44:56.006 A:middle
in the output file type.

00:44:56.626 --> 00:44:59.816 A:middle
If neither of those work, we
have no choice but to just drop

00:44:59.816 --> 00:45:01.636 A:middle
that piece of metadata
on the floor.

00:45:01.636 --> 00:45:05.766 A:middle
So in terms of guidance on how
to choose an output file type,

00:45:06.126 --> 00:45:07.776 A:middle
well, my two recommendations
are,

00:45:08.266 --> 00:45:12.876 A:middle
if you are using say an
ExportSession to copy all

00:45:12.966 --> 00:45:17.426 A:middle
of the metadata, timed or
otherwise, from the source asset

00:45:17.426 --> 00:45:20.336 A:middle
to your destination file,
the best way is to try

00:45:20.336 --> 00:45:22.766 A:middle
and use the same file type
that you started with,

00:45:22.876 --> 00:45:25.716 A:middle
and if you don't know what the
file type is you can use the

00:45:25.716 --> 00:45:27.776 A:middle
NSURLTypeIdentifierKey
to find out.

00:45:28.276 --> 00:45:32.746 A:middle
You can also always use
the QuickTime Movie file

00:45:32.746 --> 00:45:37.216 A:middle
because that is going to
have the greatest chance

00:45:37.216 --> 00:45:39.726 A:middle
of supporting your metadata
no matter where it came from.

00:45:39.966 --> 00:45:42.416 A:middle
If AVFoundation supports
it, there's a good chance

00:45:42.416 --> 00:45:44.496 A:middle
that it will be supported
by the QuickTime movie file.

00:45:44.826 --> 00:45:46.936 A:middle
Of course, this is the only way

00:45:46.936 --> 00:45:48.446 A:middle
if you're writing
timed metadata,

00:45:48.716 --> 00:45:51.326 A:middle
to get your timed
metadata into a file is

00:45:51.366 --> 00:45:53.816 A:middle
to use QuickTime Movie file;
it's the only file form

00:45:53.816 --> 00:45:55.216 A:middle
that supports it right now.

00:45:55.856 --> 00:45:58.596 A:middle
Of course good advice is always

00:45:58.596 --> 00:46:00.186 A:middle
to check the results,
no matter what.

00:46:00.886 --> 00:46:04.246 A:middle
Check that your output files
contain the kind of metadata

00:46:04.246 --> 00:46:06.436 A:middle
that you expect, all the
metadata that you expect

00:46:07.046 --> 00:46:09.036 A:middle
and you can choose to
use some of the APIs

00:46:09.146 --> 00:46:10.656 A:middle
that we've already
talked about if you want

00:46:10.656 --> 00:46:11.546 A:middle
to do that at runtime.

00:46:12.926 --> 00:46:16.106 A:middle
Some guidance if that
doesn't end up being the case:

00:46:16.196 --> 00:46:18.486 A:middle
if you don't get all the
metadata that you expect, well,

00:46:18.486 --> 00:46:20.106 A:middle
you can try to do the
conversion yourself.

00:46:20.536 --> 00:46:23.316 A:middle
Especially if you have a
custom identifier and are going

00:46:23.316 --> 00:46:25.936 A:middle
to a file type that doesn't
support your custom identifier,

00:46:26.456 --> 00:46:29.386 A:middle
take a look at that long list
of built-in identifiers we have

00:46:29.616 --> 00:46:31.746 A:middle
and see if there is something
that's roughly equivalent

00:46:31.746 --> 00:46:33.546 A:middle
to what you're trying
to store and you can do

00:46:33.546 --> 00:46:34.536 A:middle
that conversion yourself.

00:46:35.226 --> 00:46:36.966 A:middle
One particular example
I want to call

00:46:36.966 --> 00:46:39.886 A:middle
out that involves only
built-in identifiers is

00:46:39.886 --> 00:46:42.936 A:middle
when you're trying to
go from ID3 to iTunes,

00:46:43.246 --> 00:46:45.496 A:middle
well AVFoundation
currently isn't going to do

00:46:45.496 --> 00:46:46.966 A:middle
that conversion for you.

00:46:47.436 --> 00:46:49.366 A:middle
But there's no reason you
couldn't do that yourself,

00:46:49.636 --> 00:46:52.386 A:middle
so once again just take a look
at our long list of identifiers

00:46:52.626 --> 00:46:55.596 A:middle
and match them up and do the
conversion in your own code.

00:46:56.956 --> 00:46:59.146 A:middle
So that is the end of the talk.

00:46:59.496 --> 00:47:02.926 A:middle
See what we covered: we talked
obviously a lot about metadata

00:47:02.926 --> 00:47:04.986 A:middle
in AVFoundation,
we talked about all

00:47:04.986 --> 00:47:07.576 A:middle
of the different classes
you can use for inspection,

00:47:07.816 --> 00:47:10.286 A:middle
we talked about AVAsset
and AVMetadataItem

00:47:10.286 --> 00:47:12.806 A:middle
and how those work
together and also authoring,

00:47:12.806 --> 00:47:15.266 A:middle
we talked about the AssetWriter,

00:47:15.266 --> 00:47:18.376 A:middle
the AssetExportSession even
briefly on the capture audio

00:47:18.376 --> 00:47:19.556 A:middle
and movie file outputs.

00:47:20.406 --> 00:47:23.316 A:middle
We dove into timed metadata,
including all the new features

00:47:23.316 --> 00:47:26.096 A:middle
that enable things like
the dynamic location

00:47:26.316 --> 00:47:29.436 A:middle
and your own timed metadata
like the annotation demo.

00:47:30.416 --> 00:47:33.016 A:middle
We also talked about
privacy considerations

00:47:33.266 --> 00:47:36.136 A:middle
and some best practices like how
to choose the right file type.

00:47:36.546 --> 00:47:40.146 A:middle
So for more information, you
can contact our evangelism team

00:47:40.456 --> 00:47:41.826 A:middle
or see our programing guide,

00:47:42.266 --> 00:47:44.586 A:middle
there are some other
related sessions you might be

00:47:44.586 --> 00:47:45.186 A:middle
interested in.

00:47:45.486 --> 00:47:47.226 A:middle
If you missed this
morning's presentation

00:47:47.226 --> 00:47:48.926 A:middle
on "Modern Media
Playback", you can catch

00:47:48.976 --> 00:47:50.566 A:middle
that on the video recording.

00:47:51.016 --> 00:47:55.626 A:middle
Tomorrow there is also a
camera capture talk focusing

00:47:55.626 --> 00:47:56.746 A:middle
on manual controls.

00:47:57.266 --> 00:48:00.776 A:middle
And on Thursday we'll have
a talk about direct access

00:48:00.896 --> 00:48:03.546 A:middle
to video encoding and
decoding, which I'm sure a lot

00:48:03.546 --> 00:48:04.786 A:middle
of you will be interested in.

00:48:06.516 --> 00:48:13.440 A:middle
[ Silence ]